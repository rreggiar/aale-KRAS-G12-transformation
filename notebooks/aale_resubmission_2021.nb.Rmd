---
title: "Resubmission of AALE manuscript to Cell Reports"
author: 'Roman E. Reggiardo'
date: '9/22/2021'
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, collapse = T)
knitr::opts_chunk$set(message = F)
library(here)
print(here())
```

# setup:
## loading
```{r loading}
suppressPackageStartupMessages({
  library(tidyverse)
  library(here)
  library(ggsci)
  library(ggpubr)
  library(ggsignif)
  library(ggthemes) 
  library(ggrepel)
  library(ggforce)
  library(ggpmisc)
  # library(ggprism)
  library(patchwork)
  library(extrafont)
  library(ggrepel)
  library(pheatmap)
  library(viridis)
  library(patchwork)
  library(fgsea)
  # library(caret)
  library(msigdbr)
  library(matrixStats)
  # library(NMF)
  # library(rsample)
  # library(vip)
  # library(ROCR)
  # library(glmnet)
  # library(mlbench)
  library(tximeta)
  library(SummarizedExperiment)
  library(rjson)
  library(HDF5Array)
  library(DESeq2)
  # library(ggpmisc)
  library(survival)
  library(survminer)
})
suppressMessages(loadfonts())
```
## setting ggplot theme
```{r setting ggplot theme}

base_size = 10

theme_set(theme_foundation(base_size = base_size,
                           base_family = 'Helvetica') + 
            theme(plot.title = element_blank(),
                panel.background = element_rect(colour = NA),
                plot.background = element_rect(colour = NA),
                panel.border = element_rect(colour = NA), 
                axis.line = element_line(), 
                axis.line.x = NULL, 
                axis.line.y = NULL, 
                axis.text = element_text(size = rel(0.95)), 
                axis.text.x = element_text(margin = margin(t = 0.8 * base_size/4)), 
                axis.text.x.top = element_text(margin = margin(b = 0.8 * base_size/4), vjust = 0), 
                axis.text.y = element_text(margin = margin(r = 0.5 * base_size/4), hjust = 1), 
                axis.text.y.right = element_text(margin = margin(l = 0.5 * base_size/4), hjust = 0), 
                axis.ticks = element_line(), 
                axis.ticks.length = unit(base_size/2.5, "pt"), axis.ticks.length.x = NULL, 
                axis.ticks.length.x.top = NULL, axis.ticks.length.x.bottom = NULL, 
                axis.ticks.length.y = NULL, axis.ticks.length.y.left = NULL, 
                axis.ticks.length.y.right = NULL,
                strip.text = element_text(size = rel(0.95), face = 'bold'),
                strip.background = element_blank(),
                legend.key.size= unit(0.08, "in"),
                legend.spacing = unit(0, "in"),
                legend.key = element_rect(colour = NA),
                legend.title = element_text(face="italic"),
                legend.text = element_text(face = 'bold'),
                legend.justification = c("right", "top"),
                legend.box.just = "right",
                legend.margin = margin(6, 6, 6, 6),
                plot.margin=margin(0.04,
                                   0.04,
                                   0.04,
                                   0.04,
                                   unit = "in"),
                # legend.margin = margin(-0.04,
                #                    -0.02,
                #                    0.08,
                #                    0.02,
                #                    unit = "in"),
                legend.box.spacing = unit(-0.02, 'in'),
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank()
          ))

theme_set_fun <- function(){
  theme_set(theme_foundation(base_size = base_size,
                             base_family = 'Helvetica') + 
              theme(plot.title = element_blank(),
                  panel.background = element_rect(colour = NA),
                  plot.background = element_rect(colour = NA),
                  panel.border = element_rect(colour = NA), 
                  axis.line = element_line(), 
                  axis.line.x = NULL, 
                  axis.line.y = NULL, 
                  axis.text = element_text(size = rel(0.95)), 
                  axis.text.x = element_text(margin = margin(t = 0.8 * base_size/4)), 
                  axis.text.x.top = element_text(margin = margin(b = 0.8 * base_size/4), vjust = 0), 
                  axis.text.y = element_text(margin = margin(r = 0.5 * base_size/4), hjust = 1), 
                  axis.text.y.right = element_text(margin = margin(l = 0.5 * base_size/4), hjust = 0), 
                  axis.ticks = element_line(), 
                  axis.ticks.length = unit(base_size/2.5, "pt"), axis.ticks.length.x = NULL, 
                  axis.ticks.length.x.top = NULL, axis.ticks.length.x.bottom = NULL, 
                  axis.ticks.length.y = NULL, axis.ticks.length.y.left = NULL, 
                  axis.ticks.length.y.right = NULL,
                  strip.text = element_text(size = 8),
                  strip.background = element_blank(),
                  legend.key.size= unit(0.08, "in"),
                  legend.spacing = unit(0, "in"),
                  legend.key = element_rect(colour = NA),
                  legend.title = element_text(face="italic"),
                  legend.text = element_text(face = 'bold'),
                  legend.justification = c("right", "top"),
                  legend.box.just = "right",
                  legend.margin = margin(6, 6, 6, 6),
                  plot.margin=margin(0.04,
                                     0.04,
                                     0.04,
                                     0.04,
                                     unit = "in"),
                  # legend.margin = margin(-0.04,
                  #                    -0.02,
                  #                    0.08,
                  #                    0.02,
                  #                    unit = "in"),
                  legend.box.spacing = unit(-0.02, 'in'),
                  panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank()
            ))
}

```
## figure dirs, and other globally relevant constants
```{r system I/O constants}
figure.dir <-  here('figures')
data.dir <-  here('data')
output.data.dir <- here('output.data')
reference.dir <- here('reference')
job.scripts.dir <- here('R/job.scripts')

chr.order <- c('chr1', 'chr2', 'chr3', 
               'chr4', 'chr5', 'chr6', 
               'chr7', 'chr8', 'chr9',
               'chr10', 'chr11', 'chr12', 
               'chr13', 'chr14', 'chr15', 
               'chr16', 'chr17',
               'chr18', 'chr19', 'chr20', 
               'chr21', 'chr22', 'chrX', 'chrY')
```
## saving panels
```{r saving panel}
panel.figure.width = 85
panel.figure.width.medium = 114
panel.figure.width.double = 174
panel.figure.height = 279.4 
# panel.figure.width.in = 3.4252
# panel.figure.height = 22.5
# panel.figure.height.in = 8.858268

panel.save <- function(figure, name, width = 'single', height = 'single', plot.in = last_plot()){
  
  if (width == 'single'){
    panel.width = panel.figure.width
  } else if (width == 'medium'){
    panel.width = panel.figure.width.medium
  } else{
    panel.width = panel.figure.width.double
  }
  
  if (height == 'single'){
    panel.height = panel.figure.height/3
  } else if (height == 'double'){
    panel.height = (panel.figure.height/3)*1.5
  } else{
    panel.height = panel.figure.height
  }
  
  if(!dir.exists(paste0(figure.dir, '/','fig.',figure))){
    
    dir.create(paste0(figure.dir, '/','fig.',figure))
    
  }
  
  ggsave(paste0(figure.dir,
                '/',
                'fig.',
                figure,
                '/', 
                name, 
                '.',
                panel.width, 
                'x', 
                panel.height, 
                '.pdf'),
       width = panel.width, 
       height = panel.height, 
       units = 'mm', plot = plot.in)
}

save_pheatmap_pdf <- function(x, filename, width=panel.figure.width, height=3) {
   stopifnot(!missing(x))
   stopifnot(!missing(filename))
   pdf(filename, width=unit(width, 'mm'), height=unit(height, 'mm'), family = 'Helvetica')
   grid::grid.newpage()
   grid::grid.draw(x$gtable)
   dev.off()
}

## https://jokergoo.github.io/2020/05/11/set-cell-width/height-in-the-heatmap/
calc_ht_size = function(ht, unit = "mm") {
    pdf(NULL)
    ht = ComplexHeatmap::draw(ht)
    w = ComplexHeatmap:::width(ht)
    w = grid::convertX(w, unit, valueOnly = TRUE)
    h = ComplexHeatmap:::height(ht)
    h = grid::convertY(h, unit, valueOnly = TRUE)
    dev.off()

    c(w, h)
}
```
## gene sets for filtering, identification
```{r gene set I/O}

if (! file.exists(file.path(output.data.dir, 'meta_data_df.rds'))) {
  
  meta_data <- lst()
  
  meta_data$te.clades <- 
  read_csv(file.path(output.data.dir, 'reference.data','te.clades.csv'))

  meta_data$te.families.clades <- 
    read_csv(file.path(output.data.dir, 'reference.data','te.family.clade.csv'),
             col_names = c('gene', 'family', 'clade')) %>% 
    distinct()
  
  meta_data$trono.krab.znfs <- 
    read_csv(file.path(output.data.dir, 'krab.znf.trono.list.csv'), 
             col_names = c('gene', 'biotype', 'ensg', 'chr', 'start', 'end', 'strand', 'ZNF'))
  
  meta_data$gen.24.names <- 
    read_csv(file.path(output.data.dir, 'reference.data/gen.24.names.csv'),
             col_names = c('enst','ensg','tx','gene','len','biotype')) %>% 
    select(ensg, gene) %>% 
    distinct()
  
  meta_data$gencode.35.tx.to.gene <- 
    read_csv(file.path(reference.dir, 'gencode.v35.tx.to.gene.csv'), 
                                    col_names = c('tx', 'gene')) %>% 
    separate(tx, sep = '\\|', into = c('enst','ensg',NA,NA,'tx','gene','len','biotype'))
  
  meta_data$gencode.35.tx.to.gene %>% 
    dplyr::select(-enst) %>% 
    group_by(biotype) %>% 
    tally() -> gen.35.biotype.count
  
  meta_data$gencode.35.lnc.gene.names <- 
    read_csv(file.path(reference.dir, 'gencode.v35.lncRNA.gene.names.txt'), 
             col_names = 'gene')
  
  meta_data$ucsc.rmsk.tx.to.gene <-  
    read_csv(file.path(reference.dir, 'gencode.v35.ucsc.rmsk.tx.to.gene.csv'), 
                                    col_names = c('enst', 'gene')) %>%
    filter(grepl('^hg38', enst))
  
  ucsc.rmsk.tx.to.gene %>% 
    mutate(tx = enst) %>% 
    separate(tx, sep = '_', into = c(NA, NA, 'gene', 'position', NA, NA, 'strand', NA)) %>% 
    mutate(position = sub('range=', '', position),
           strand = sub('strand=', '', strand)) %>% 
    merge(te.families.clades, by = 'gene') %>% 
    mutate(tmp.gene = gene,
           ensg = NA) %>% 
    dplyr::select(enst, ensg, 'gene' = tmp.gene, 'len' = clade, 'biotype' = family) -> meta_data$ucsc.rmsk.tx.to.gene.fmt
  
  
  meta_data$tot.gencode.35.tx.to.gene <- 
    read_csv(file.path(reference.dir, 'gencode.v35.tx.to.gene.csv'), 
                                    col_names = c('tx', 'gene')) %>% 
    mutate(enst = tx) %>% 
    separate(tx, sep = '\\|', into = c(NA,'ensg',NA,NA,'tx','gene','len','biotype'))
  
  meta_data$total.tx.to.gene <- 
    rbind(tot.gencode.35.tx.to.gene %>% dplyr::select(enst, ensg, gene, len, biotype),
          ucsc.rmsk.tx.to.gene.fmt %>% dplyr::select(enst = enst, ensg, gene, len, biotype))
  
  
  meta_data$panc_methylation_df <- read_tsv(file.path(output.data.dir, 'GSE119548_avg_beta.txt.gz'))
  
  saveRDS(meta_data, file.path(output.data.dir, 'meta_data_df.rds'))
  
} else {
  meta.data <- readRDS(file.path(output.data.dir, 'meta_data_df.rds'))
}


```

```{r ip tables}
# te.locus.count <- 
#   read_csv(file.path(output.data.dir, 'pancreas.plasma.ev.long.RNA.normalized.deseq.tx.counts.csv')) %>%
#   rename('X1' = 'tx')
# 
# read_csv(file.path(output.data.dir, 
#                    'pancreas.plasma.ev.long.RNA.normalized.deseq.gene.diseaseState_PDAC_vs_healthy.lfcShrink.csv')) %>% 
#   drop_na() %>% 
#   rename('X1' = 'gene') %>% 
#   filter(!grepl('^MT', gene),
#          abs(lfcShrinkResults.log2FoldChange) >= 0.5) %>% 
#   merge(te.families.clades, by = 'gene') %>% 
#   mutate(family = ifelse(is.na(family), clade, family), 
#          clade = factor(clade, levels = c('coding-gencode', 'lncRNA', 'DNA', 'LINE', 'LTR', 'SINE'))) %>% 
#   filter(!grepl('\\(', gene)) %>% 
#   mutate(genome = 'hg38') -> panc_v_ctrl_te.ip.parse
# 
# 
# te.locus.count %>% 
#   filter(!grepl('^ENST', tx)) %>% 
#   filter_at(vars(contains('SRR')), any_vars(. > 5)) %>% 
#   separate(tx, '=', into = c('name', 'position')) %>% 
#   separate(name, '_', into = c(NA,NA,'name',NA)) %>%
#   merge(te.families.clades, by.x = 'name', by.y = 'gene') %>% 
#   separate(position, ':', into = c('chr', 'position')) %>% 
#   separate(position, '_', into = c('position', NA)) %>% 
#   separate(position, '-', into = c('start', 'end')) %>% 
#   dplyr::select(gene='name', chr, start, end, clade, contains('SRR')) %>% 
#   filter(gene %in% panc_v_ctrl_te.ip.parse$gene) %>% 
#   gather(patient, count, -chr, -start, -end, -gene, -clade) %>% 
#   group_by(chr, start, end, gene, clade) %>% 
#   summarize(avg_count = mean(count)) %>% 
#   mutate(start = as.numeric(start),
#            chr = factor(chr, levels = chr.order)) %>% 
#   merge(panc_v_ctrl_te.ip.parse %>% dplyr::select(-clade), by = 'gene') -> panc_v_ctrl_te.ip.table
# 
# write_csv(x = panc_v_ctrl_te.ip.table, 
#           file.path(output.data.dir, 'panc_v_healthy.gut.paper.te.ip.table.RENAME.COLUMNS.csv'))
```

# feature engineering:
## FUN: construct.quant.object
```{r}
load.tximeta.object <- function(reference){
  
  print(file.path(output.data.dir, paste0(reference, '_h5_se')))
  
  txi <- loadHDF5SummarizedExperiment(dir=file.path(output.data.dir, paste0(reference, '_h5_se')))
  gxi <- loadHDF5SummarizedExperiment(dir=file.path(output.data.dir, paste0(reference, '_gene_h5_se')))
  
  if (reference == 'process.aware.salmon'){
    
    gxi.split <- loadHDF5SummarizedExperiment(dir=file.path(output.data.dir, paste0(reference, '_gene_split_h5_se')))
    
    return(list('txi' = txi, 'gxi' = gxi, 'gxi.split' = gxi.split))
    
  } else {
    
    return(list('txi' = txi, 'gxi' = gxi))
  }
  
}

subset.tximeta.object <- function(tximeta.list, grep.string){
  
  if (grepl('\\|', grep.string)){
      
    subset.txi <- SummarizedExperiment::subset(tximeta.list$txi, 
                                         select = !grepl(grep.string, colData(tximeta.list$txi)$names))
  
    subset.gxi <- SummarizedExperiment::subset(tximeta.list$gxi, 
                                         select = !grepl(grep.string, colData(tximeta.list$gxi)$names))
  } else{
        
    subset.txi <- SummarizedExperiment::subset(tximeta.list$txi, 
                                         select = grepl(grep.string, colData(tximeta.list$txi)$names))
  
    subset.gxi <- SummarizedExperiment::subset(tximeta.list$gxi, 
                                         select = grepl(grep.string, colData(tximeta.list$gxi)$names))
  }
  
  return(list('txi' = subset.txi,
              'gxi' = subset.gxi))
}
```
### CALL: construct.quant.object
```{r}
salmon.quant <- load.tximeta.object('salmon')

salmon.quant$aale$intra <- subset.tximeta.object(salmon.quant, 'intra.aale')
salmon.quant$hbec$hbec_wt <- subset.tximeta.object(salmon.quant, 'wt2_kras')
salmon.quant$hbec$hbec_v12 <- subset.tximeta.object(salmon.quant, '_v12')
salmon.quant$hbec$lacz_v_wt <- subset.tximeta.object(salmon.quant, '_v12|mut2|aale|ZNF|Empty')
salmon.quant$hbec$lacz_v_v12 <- subset.tximeta.object(salmon.quant, '_wt|mut2|aale|ZNF|Empty')
salmon.quant$a549 <- subset.tximeta.object(salmon.quant, 'intra.a549')
salmon.quant$all_intra <- subset.tximeta.object(salmon.quant, 'rnaEASY|hold')
salmon.quant$aale$exo <- subset.tximeta.object(salmon.quant, 'rnaEASY.aale')
salmon.quant$aale$kras_compare <- subset.tximeta.object(salmon.quant, 'aale.*.kras')
salmon.quant$aale$ctrl_compare <- subset.tximeta.object(salmon.quant, 'aale.*.ctrl')
salmon.quant$aale$platform_compare <- subset.tximeta.object(salmon.quant, 'aale')

colData(salmon.quant$gxi) %>% 
  as.data.frame() %>% 
  remove_rownames() -> salmon.quant$meta.data.df

rowRanges(salmon.quant$gxi) %>% 
  as.data.frame() %>% 
  dplyr::rename('chr' = seqnames) %>% 
  merge(gencode.35.tx.to.gene %>% select(ensg, gene) %>% distinct(), by.x = 'gene_id', by.y = 'ensg') -> 
  salmon.quant$gxi.bed

rowRanges(salmon.quant$txi) %>% 
  as.data.frame() %>% 
  dplyr::rename('chr' = seqnames) %>% 
  merge(gencode.35.tx.to.gene %>% select(enst, gene) %>% distinct(), by.x = 'tx_name', by.y = 'enst') -> 
  salmon.quant$txi.bed

# ------------------------------------------------------------------------------

ucsc.rmsk.salmon.quant <- load.tximeta.object('ucsc.rmsk.salmon')

ucsc.rmsk.salmon.quant$aale$intra <- 
  subset.tximeta.object(ucsc.rmsk.salmon.quant, 'intra.aale')
ucsc.rmsk.salmon.quant$hbec$hbec_wt <- 
  subset.tximeta.object(ucsc.rmsk.salmon.quant, 'wt2_kras')
ucsc.rmsk.salmon.quant$hbec$hbec_v12 <- 
  subset.tximeta.object(ucsc.rmsk.salmon.quant, '_v12')
ucsc.rmsk.salmon.quant$hbec$lacz_v_wt <- 
  subset.tximeta.object(ucsc.rmsk.salmon.quant, '_v12|mut2|aale|ZNF|Empty')
ucsc.rmsk.salmon.quant$hbec$lacz_v_v12 <- 
  subset.tximeta.object(ucsc.rmsk.salmon.quant, '_wt|mut2|aale|ZNF|Empty')
ucsc.rmsk.salmon.quant$a549 <- 
  subset.tximeta.object(ucsc.rmsk.salmon.quant, 'intra.a549')
ucsc.rmsk.salmon.quant$all_intra <- 
  subset.tximeta.object(ucsc.rmsk.salmon.quant, 'rnaEASY|hold')
ucsc.rmsk.salmon.quant$aale$exo <- 
  subset.tximeta.object(ucsc.rmsk.salmon.quant, 'rnaEASY.aale')
ucsc.rmsk.salmon.quant$aale$kras_compare <- 
  subset.tximeta.object(ucsc.rmsk.salmon.quant, 'aale.*.kras')
ucsc.rmsk.salmon.quant$aale$ctrl_compare <- 
  subset.tximeta.object(ucsc.rmsk.salmon.quant, 'aale.*.ctrl')
ucsc.rmsk.salmon.quant$aale$platform_compare <- 
  subset.tximeta.object(ucsc.rmsk.salmon.quant, 'aale')

colData(ucsc.rmsk.salmon.quant$gxi) %>% 
  as.data.frame() %>% 
  remove_rownames() -> ucsc.rmsk.salmon.quant$meta.data.df

```

## FUN: run.de.seq
```{r}
run.de.seq <- function(tximeta.object, base_level = 'ctrl'){
  
  tximeta.name <- deparse(substitute(tximeta.object))
  
  print(tximeta.name)
  
  colData(tximeta.object$gxi) %>% 
    as.data.frame() %>% 
    remove_rownames() %>% 
    mutate(condition = relevel(as.factor(condition), base_level)) -> colData.gxi
  
  print(levels(colData.gxi$condition))
  
  print(colData.gxi)

  count.matrix.gxi <- assay(tximeta.object$gxi, 'counts') %>% 
    as.data.frame() %>% 
    rownames_to_column('gene') %>% 
    mutate_if(is.numeric, round) %>% 
    column_to_rownames('gene')
    
  colData(tximeta.object$txi) %>% 
    as.data.frame() %>% 
    remove_rownames() -> colData.txi

  count.matrix.txi <- assay(tximeta.object$txi, 'counts') %>% 
    as.data.frame() %>% 
    rownames_to_column('tmp') %>% 
    mutate_if(is.numeric, round) %>% 
    column_to_rownames('tmp')
  
  if (grepl('compare', tximeta.name)) {
    
    colData.gxi$platform <- relevel(as.factor(colData.gxi$platform), 'intra')
    
    dds.gxi <- DESeqDataSetFromMatrix(countData = count.matrix.gxi, 
                                    colData = colData.gxi, 
                                    design = as.formula(~platform))

    dds.txi <- DESeqDataSetFromMatrix(countData = count.matrix.txi, 
                                      colData = colData.txi, 
                                      design = as.formula(~platform))
    
  } else {
    
    dds.gxi <- DESeqDataSetFromMatrix(countData = count.matrix.gxi, 
                                    colData = colData.gxi, 
                                    design = as.formula(~condition))

    dds.txi <- DESeqDataSetFromMatrix(countData = count.matrix.txi, 
                                      colData = colData.txi, 
                                      design = as.formula(~condition))
    
  }
  
  dds.txi <- estimateSizeFactors(dds.txi)
  
  dds.txi.norm.counts <- as.data.frame(counts(dds.txi, normalized=T))
  
  dds.txi.vst.counts <- as.data.frame(assay(vst(dds.txi, blind = F)))
  
  dds.gxi <- estimateSizeFactors(dds.gxi)
  
  dds.gxi.norm.counts <- as.data.frame(counts(dds.gxi, normalized=T))
  
  dds.gxi.vst.counts <-  as.data.frame(assay(vst(dds.gxi, blind = F)))
  
  if (grepl('all_intra|a549', tximeta.name)){
    print('no DE calc')
      if (grepl('ucsc.rmsk', tximeta.name)){  
    
        print('rmsk')
    
        dds.gxi.norm.counts <- dds.gxi.norm.counts %>% 
          rownames_to_column('gene') 
        
        return(list('counts' = dds.gxi.norm.counts,
                    'txi.counts' = dds.txi.norm.counts,
                    'gxi.vst.counts' = dds.gxi.vst.counts,
                    'col.data' = colData.txi))
        
        quit()
      }
    
      dds.gxi.norm.counts <- 
        dds.gxi.norm.counts %>% 
          rownames_to_column('gene_id') %>% 
          merge(salmon.quant$gxi.bed, by = 'gene_id') %>% 
          distinct()
      
      dds.txi.norm.counts <- 
        dds.gxi.norm.counts %>% 
          rownames_to_column('tx_name') %>% 
          merge(salmon.quant$txi.bed, by = 'tx_name') %>% 
          distinct() 
    
      return(list('counts' = dds.gxi.norm.counts, 
                  'txi.counts' = dds.txi.norm.counts,
                  'gxi.vst.counts' = dds.gxi.vst.counts,
                  'col.data' = colData.txi))
      quit()

  }
  
  filter <- rowSums(counts(dds.gxi, normalized=T) >= 10) >= 2
  
  dds.gxi <- DESeq(dds.gxi[filter,])
  
  print(resultsNames(dds.gxi))
  
  coef = print(tail(resultsNames(dds.gxi), n=1))

  if (grepl('ucsc.rmsk', tximeta.name)){  
    
    print('rmsk')
    
    dds.gxi.lfc <- lfcShrink(dds.gxi, coef = coef) %>% 
      as.data.frame() %>% 
      # filter(padj <= 0.05) %>% 
      rownames_to_column('gene') %>% 
      dplyr::select(gene, baseMean, log2FoldChange, padj)
    
    dds.gxi.norm.counts <- dds.gxi.norm.counts %>% 
      rownames_to_column('gene') 
    
  } else{
    
    dds.gxi.lfc <- lfcShrink(dds.gxi, coef = coef) %>% 
      as.data.frame() %>% 
      # filter(padj <= 0.05) %>% 
      rownames_to_column('gene_id') %>% 
      merge(salmon.quant$gxi.bed, by = 'gene_id')
    
    plotMA(lfcShrink(dds.gxi, coef = coef))
    
    dds.gxi.norm.counts <- 
      dds.gxi.norm.counts %>% 
        rownames_to_column('gene_id') %>% 
        merge(salmon.quant$gxi.bed, by = 'gene_id') %>% 
        distinct()
    
    dds.txi.norm.counts <- 
      dds.gxi.norm.counts %>% 
        rownames_to_column('tx_name') %>% 
        merge(salmon.quant$txi.bed, by = 'tx_name') %>% 
        distinct() 
  }

return(list('de' = dds.gxi.lfc, 
            'counts' = dds.gxi.norm.counts, 
            'txi.counts' = dds.txi.norm.counts, 
            'txi.vst.counts' = dds.txi.vst.counts,
            'gxi.vst.counts' = dds.gxi.vst.counts,
            'col.data' = colData.txi))
  
}

run.de.seq.contrast <- function(tximeta.object, base_level = 'ctrl'){
  
  tximeta.name <- deparse(substitute(tximeta.object))
  
  print(tximeta.name)
  
  colData(tximeta.object$gxi) %>% 
    as.data.frame() %>% 
    remove_rownames() %>% 
    mutate(condition = relevel(as.factor(condition), base_level)) -> colData.gxi
  
  print(levels(colData.gxi$condition))
  
  print(colData.gxi)

  count.matrix.gxi <- assay(tximeta.object$gxi, 'counts') %>% 
    as.data.frame() %>% 
    rownames_to_column('gene') %>% 
    mutate_if(is.numeric, round) %>% 
    column_to_rownames('gene')
    
  colData(tximeta.object$txi) %>% 
    as.data.frame() %>% 
    remove_rownames() -> colData.txi

  count.matrix.txi <- assay(tximeta.object$txi, 'counts') %>% 
    as.data.frame() %>% 
    rownames_to_column('tmp') %>% 
    mutate_if(is.numeric, round) %>% 
    column_to_rownames('tmp')
  
  colData.gxi$platform <- relevel(as.factor(colData.gxi$platform), 'intra')
  
  dds.gxi <- DESeqDataSetFromMatrix(countData = count.matrix.gxi, 
                                  colData = colData.gxi, 
                                  design = as.formula(~condition + platform + platform:condition))

  dds.txi <- DESeqDataSetFromMatrix(countData = count.matrix.txi, 
                                    colData = colData.txi, 
                                    design = as.formula(~platform))
  
  dds.gxi <- estimateSizeFactors(dds.gxi)
  
  filter <- rowSums(counts(dds.gxi, normalized=T) >= 10) >= 2
  
  dds.gxi <- DESeq(dds.gxi[filter,])
  
  print(resultsNames(dds.gxi))
  
  results(dds.gxi, contrast =list("conditionkras.platformrnaEASY"))

  dds.gxi.lfc <- lfcShrink(dds.gxi, coef = "conditionkras.platformrnaEASY") %>%
    as.data.frame() %>%
    # filter(padj <= 0.05) %>%
    rownames_to_column('gene_id') %>%
    merge(salmon.quant$gxi.bed, by = 'gene_id')

  dds.gxi.lfc
  
  
}

```
## CALL: run.de.seq
```{r}
salmon.quant$aale$intra$deseq <- run.de.seq(salmon.quant$aale$intra, base_level = 'ctrl')
salmon.quant$aale$exo$deseq <- run.de.seq(salmon.quant$aale$exo, base_level = 'ctrl')
salmon.quant$aale$kras_compare$deseq <- run.de.seq(salmon.quant$aale$kras_compare, base_level = 'kras')
salmon.quant$aale$ctrl_compare$deseq <- run.de.seq(salmon.quant$aale$ctrl_compare, base_level = 'ctrl')
salmon.quant$aale$platform_compare$deseq <- run.de.seq(salmon.quant$aale$platform_compare, base_level = 'ctrl')
salmon.quant$hbec$hbec_wt$deseq <- run.de.seq(salmon.quant$hbec$hbec_wt, base_level = 'wt2_kras_wt')
salmon.quant$hbec$hbec_v12$deseq <- run.de.seq(salmon.quant$hbec$hbec_v12, base_level = 'wt2_kras_v12')
salmon.quant$hbec$lacz_v_wt$deseq <- run.de.seq(salmon.quant$hbec$lacz_v_wt, base_level = 'wt2_lacz')
salmon.quant$hbec$lacz_v_v12$deseq <- run.de.seq(salmon.quant$hbec$lacz_v_v12, base_level = 'wt2_lacz')
salmon.quant$a549$deseq <- run.de.seq(salmon.quant$a549, base_case = 'Empty')
salmon.quant$all_intra$deseq <- run.de.seq(salmon.quant$all_intra)

tmp <- run.de.seq.contrast(salmon.quant$aale$platform_compare)

View(tmp %>% filter(padj < 0.01))

tmp %>% filter(gene %in% salmon.quant$aale$intra$deseq$de$gene) %>% View()

salmon.quant$aale$exo$deseq$de %>% 
  merge(tmp, by = 'gene') %>% 
  ggplot(aes(log2FoldChange.x, log2FoldChange.y, label = gene)) + 
  geom_point()+
  geom_text_repel(aes(label = ifelse(abs(log2FoldChange.x) > 2, gene, '')))


# ------------------------------------------------------------------------------

ucsc.rmsk.salmon.quant$aale$intra$deseq <- run.de.seq(ucsc.rmsk.salmon.quant$aale$intra, base_level = 'ctrl')
ucsc.rmsk.salmon.quant$aale$exo$deseq <- run.de.seq(ucsc.rmsk.salmon.quant$aale$exo, base_level = 'ctrl')
ucsc.rmsk.salmon.quant$aale$kras_compare$deseq <- 
  run.de.seq(ucsc.rmsk.salmon.quant$aale$kras_compare, base_level = 'kras')
ucsc.rmsk.salmon.quant$aale$ctrl_compare$deseq <- 
  run.de.seq(ucsc.rmsk.salmon.quant$aale$ctrl_compare, base_level = 'ctrl')
ucsc.rmsk.salmon.quant$aale$platform_compare$deseq <- 
  run.de.seq(ucsc.rmsk.salmon.quant$aale$platform_compare, base_level = 'ctrl')
# ucsc.rmsk.salmon.quant$hbec$hbec_wt$deseq <- run.de.seq(ucsc.rmsk.salmon.quant$hbec$hbec_wt, base_level = 'wt2_kras_wt')
# ucsc.rmsk.salmon.quant$hbec$hbec_v12$deseq <- run.de.seq(ucsc.rmsk.salmon.quant$hbec$hbec_v12, base_level = 'wt2_kras_v12')
# ucsc.rmsk.salmon.quant$hbec$lacz_v_wt$deseq <- run.de.seq(ucsc.rmsk.salmon.quant$hbec$lacz_v_wt, base_level = 'wt2_lacz')
ucsc.rmsk.salmon.quant$hbec$lacz_v_v12$deseq <- run.de.seq(ucsc.rmsk.salmon.quant$hbec$lacz_v_v12, base_level = 'wt2_lacz')
ucsc.rmsk.salmon.quant$hbec$a549$deseq <- run.de.seq(ucsc.rmsk.salmon.quant$a549, base_case = 'Empty')
ucsc.rmsk.salmon.quant$all_intra$deseq <- run.de.seq(ucsc.rmsk.salmon.quant$all_intra)

saveRDS(ucsc.rmsk.salmon.quant, file = file.path(output.data.dir, 'ucsc.rmsk.salmon.quant_analysis_set.rds'))



```

## FUN: make.fgsea.ranks
```{r}
make.fgsea.ranks <- function(de.seq){
  
  # build a ranked gene list in the appropriate format (named list)
  # using shrunken log2 Fold Change values from DESeqII
  de.seq <- 
    de.seq %>%
    mutate(rank = as.double(log2FoldChange),
           Gene = as.character(gene)) %>% 
    dplyr::select(Gene, rank) %>%
    mutate(rank = scale(rank)) 
  
  de.seq.rnk <- 
    de.seq$rank
  de.seq.rnk <- 
    setNames(de.seq$rank, de.seq$Gene)

  # run the GSEA implementation on the hallmark sets supplemented with custom sets
  print('fgsea')
  de.seq.fgsea.res <- 
    fgsea(pathways = msig.df, 
          stats = de.seq.rnk, eps = 0.0)
  
  print('padj filter and clean names')
  # convert to a tidy format, clean the names for display
  de.seq.fgsea.df <-
    as_tibble(de.seq.fgsea.res) %>%
    filter(padj < 0.05) %>%
    mutate(pathway = gsub('_', ' ', pathway))

  
  return(de.seq.fgsea.df)
  
}


```
### CALL: make.fgsea.ranks
```{r}
msig.df <- 
  msigdbr(species = 'Homo sapiens', category = 'H') %>% 
  dplyr::select(gene_symbol, gs_name) %>% 
  split(x = .$gene_symbol, f = .$gs_name)

msig.df$HALLMARK_KRAS_G12D_ZNF_DN <- salmon.quant$aale$intra$deseq$de %>% 
  filter(gene %in% filter(meta.data$trono.krab.znfs, ZNF == 'KRAB-ZNFs')$gene,
         log2FoldChange <= -1) %>% 
  dplyr::select(gene) %>% unlist() %>% unname()

salmon.quant$aale$intra$deseq$H.fgsea <- make.fgsea.ranks(salmon.quant$aale$intra$deseq$de)
salmon.quant$aale$exo$deseq$H.fgsea <- make.fgsea.ranks(salmon.quant$aale$exo$deseq$de)
salmon.quant$aale$kras_compare$deseq$H.fgsea <- make.fgsea.ranks(salmon.quant$aale$kras_compare$deseq$de)
salmon.quant$aale$ctrl_compare$deseq$H.fgsea <- make.fgsea.ranks(salmon.quant$aale$ctrl_compare$deseq$de)
salmon.quant$aale$platform_compare$deseq$H.fgsea <- make.fgsea.ranks(salmon.quant$aale$platform_compare$deseq$de)
salmon.quant$hbec$hbec_wt$deseq$H.fgsea <- make.fgsea.ranks(salmon.quant$hbec$hbec_wt$deseq$de)
salmon.quant$hbec$hbec_v12$deseq$H.fgsea <- make.fgsea.ranks(salmon.quant$hbec$hbec_v12$deseq$de)
salmon.quant$hbec$lacz_v_wt$deseq$H.fgsea <-make.fgsea.ranks(salmon.quant$hbec$lacz_v_wt$deseq$de)
salmon.quant$hbec$lacz_v_v12$deseq$H.fgsea <- make.fgsea.ranks(salmon.quant$hbec$lacz_v_v12$deseq$de)

# saveRDS(salmon.quant, file = file.path(output.data.dir, 'salmon.quant_analysis_set.rds'))

msig.df <- 
  msigdbr(species = 'Homo sapiens') %>% 
  dplyr::select(gene_symbol, gs_name) %>% 
  filter(!grepl('HALLMARK', gs_name)) %>% 
  split(x = .$gene_symbol, f = .$gs_name)

salmon.quant$aale$intra$deseq$A.fgsea <- make.fgsea.ranks(salmon.quant$aale$intra$deseq$de)
salmon.quant$aale$exo$deseq$A.fgsea <- make.fgsea.ranks(salmon.quant$aale$exo$deseq$de)
salmon.quant$aale$kras_compare$deseq$A.fgsea <- make.fgsea.ranks(salmon.quant$aale$kras_compare$deseq$de)
salmon.quant$aale$ctrl_compare$deseq$A.fgsea <- make.fgsea.ranks(salmon.quant$aale$ctrl_compare$deseq$de)
salmon.quant$aale$platform_compare$deseq$A.fgsea <- make.fgsea.ranks(salmon.quant$aale$platform_compare$deseq$de)
salmon.quant$hbec$hbec_wt$deseq$A.fgsea <- make.fgsea.ranks(salmon.quant$hbec$hbec_wt$deseq$de)
salmon.quant$hbec$hbec_v12$deseq$A.fgsea <- make.fgsea.ranks(salmon.quant$hbec$hbec_v12$deseq$de)
salmon.quant$hbec$lacz_v_wt$deseq$A.fgsea <- make.fgsea.ranks(salmon.quant$hbec$lacz_v_wt$deseq$de)
salmon.quant$hbec$lacz_v_v12$deseq$A.fgsea <- make.fgsea.ranks(salmon.quant$hbec$lacz_v_v12$deseq$de)

saveRDS(salmon.quant, file = file.path(output.data.dir, 'usalmon.quant_analysis_set.rds'))

```

```{r}

salmon.quant <- readRDS(file = file.path(output.data.dir, 'salmon.quant_analysis_set.rds'))

lapply(c(1,2), function(i) { 
  
  imap(salmon.quant[names(salmon.quant) %in% c('aale', 'hbec')][[i]], function(x, x_name) {
    
    x$deseq$de %>%
      filter(abs(log2FoldChange) > 1, padj < 0.05, gene %in% msig.df$HALLMARK_INTERFERON_ALPHA_RESPONSE) %>% 
      mutate(id = x_name)
    
  })
}) %>% purrr::flatten() %>% 
  bind_rows() %>% 
  filter(!grepl('compare|hbec_|v_wt', id)) %>% 
  group_by(gene) %>% 
  summarize(context = list(id)) %>% 
  ggplot(aes(context)) + 
  geom_bar() + 
  ggupset::scale_x_upset() +
  geom_text(stat='count', aes(label=after_stat(count)))

msig.df[grepl('INTERFERON|INFLAMMATORY', names(msig.df))] %>% 
  lapply(function(x) as.data.frame(x)) %>% 
  bind_rows(.id = 'pathway') %>% 
  rbind(salmon.quant$aale$intra$deseq$de %>% 
          filter(log2FoldChange > 1, padj < 0.05) %>% 
          mutate(pathway = 'kras.intra') %>% select(pathway, 'x' = gene)) %>% 
  group_by(x) %>% 
  summarize(pathways = list(pathway)) %>% 
  ggplot(aes(pathways)) + 
  geom_bar() + 
  ggupset::scale_x_upset() +
  geom_text(stat='count', aes(label=after_stat(count)), vjust = -0.5)

salmon.quant$aale$intra$deseq$de %>% 
          filter(padj < 0.05) %>%
  mutate(pathway = ifelse(gene %in% msig.df$HALLMARK_INTERFERON_ALPHA_RESPONSE, 'IFNA', 'other')) %>% 
  ggplot(aes(log2FoldChange, -log10(padj), color = pathway)) + 
  geom_point(alpha = 0.3)

salmon.quant$aale$intra$deseq$de %>% filter(padj< 0.05) %>% 
  merge(salmon.quant$aale$exo$deseq$de %>% filter(padj < 0.05), by = 'gene') %>% 
  mutate(pathway = ifelse(gene %in% msig.df$HALLMARK_INTERFERON_ALPHA_RESPONSE, 'IFNA', 'other')) %>%
  ggplot(aes(log2FoldChange.x, log2FoldChange.y, color = pathway)) + 
  geom_point(alpha = 0.3)

library(rGREAT)

salmon.quant$gxi.bed %>% 
  filter(gene %in% filter(salmon.quant$aale$intra$deseq$de, padj < 0.01, log2FoldChange > 1)$gene) %>% 
  select(chr, start, end, gene, strand) -> input_bed

job <- rGREAT::submitGreatJob(input_bed, species = 'hg38')

tb <- rGREAT::getEnrichmentTables(job)

plotRegionGeneAssociationGraphs(job)[, 1:2] %>% as.data.frame()

availableOntologies(job)



```

```{r}
library(GenomicRanges)
library(BSgenome.Hsapiens.UCSC.hg38)
library(BSgenome)

ifn_g <- msig.df$HALLMARK_INTERFERON_ALPHA_RESPONSE
ifn_a <- msig.df$HALLMARK_INTERFERON_GAMMA_RESPONSE

options(meme_db = file.path(output.data.dir, 'reference.data', 
                            'HOCOMOCOv11_core_HUMAN_mono_meme_format.meme'))

salmon.quant$aale$intra$deseq$de %>% 
  filter(padj < 0.05, log2FoldChange > 0.5) %>% #, gene %in% c(ifn_g, ifn_a)) %>% 
  # filter(gene %in% filter(salmon.quant$hbec$lacz_v_v12$deseq$de, padj < 0.05, log2FoldChange > 0)$gene) %>% 
  select(gene_id) %>% unlist() %>% unname() -> de_list

salmon.quant$aale$intra$deseq$de %>% 
  filter(padj < 0.05, log2FoldChange < -0.5) %>% #, gene %in% c(ifn_g, ifn_a)) %>% 
  # filter(gene %in% filter(salmon.quant$hbec$lacz_v_v12$deseq$de, padj < 0.05, log2FoldChange > 0)$gene) %>% 
  select(gene_id) %>% unlist() %>% unname() -> de_list_w_hbec


# salmon.quant$hbec$lacz_v_v12$deseq$de %>% 
#   filter(padj < 0.05, log2FoldChange > 0) %>% #, gene %in% c(ifn_g, ifn_a)) %>% 
#   filter(!gene %in% filter(salmon.quant$aale$intra$deseq$de, padj < 0.05, log2FoldChange > 0)$gene) %>% 
#   select(gene_id) %>% unlist() %>% unname() -> de_list_w_hbec

gr <- rowRanges(salmon.quant$gxi)

ifn_de_gr <- gr[names(gr) %in% de_list]
ifn_de_gr_hbec <- gr[names(gr) %in% de_list_w_hbec]

promoter_seqs <- 
  GenomicFeatures::getPromoterSeq(subject = BSgenome.Hsapiens.UCSC.hg38, 
                                  query = ifn_de_gr, upstream = 1000, downstream = 500)

promoter_seqs_hbec <- 
  GenomicFeatures::getPromoterSeq(subject = BSgenome.Hsapiens.UCSC.hg38, 
                                   query = ifn_de_gr_hbec, upstream = 1000, downstream = 500)


# dreme_results <- memes::runDreme(promoter_seqs, control = "shuffle")
# 
tomTom_res <- memes::runAme(control = promoter_seqs_hbec,
                            input = promoter_seqs)

tomTom_res %>% 
  mutate(tmp = motif_id) %>% 
  separate(tmp, sep = '_', into = c('TF', NA)) %>% 
  mutate(TF = str_replace(TF, pattern = '^ZN', replacement = 'ZNF')) -> ame_tf
# %>% 
  # select(TF) %>% unlist() %>% unname() -> ame_tf

salmon.quant$aale$intra$deseq$de %>% 
  merge(ame_tf, by.x = 'gene', by.y = 'TF') %>% 
  # filter(gene %in% ame_tf) %>% 
  ggplot(aes(log2FoldChange, -log10(padj), color = adj.pvalue, label = gene)) + 
  geom_point() + 
  scale_color_viridis_c(direction = -1, name = 'ame adj.pval') +
  geom_text_repel(color = 'black') + 
  geom_vline(xintercept = 0, alpha = 0.3, linetype = 'dashed') + 
  theme(legend.position = c(0.35, 0.99)) 

panel.save(figure = 1, name = 'enriched_tf_volcano', width = 'single', height = 'single')


isre_motif <- MotifDb::query(MotifDb::MotifDb, "ISRE") %>% 
  universalmotif::convert_motifs()

isre_motif <- isre_motif[[1]]

irf9_motif <- MotifDb::query(MotifDb::MotifDb, "IRF9_HUMAN.H11MO.0.C") %>% 
  universalmotif::convert_motifs()

irf7_motif <- MotifDb::query(MotifDb::MotifDb, "IRF7_HUMAN.H11MO.0.C") %>% 
  universalmotif::convert_motifs()

fos_motif <- MotifDb::query(MotifDb::MotifDb, "AP-1") %>% 
  universalmotif::convert_motifs()

foxp2_motif <- MotifDb::query(MotifDb::MotifDb, 'FOXP2_HUMAN.H11MO.0.C') %>% 
  universalmotif::convert_motifs()

isre_fimo_results <- memes::runFimo(promoter_seqs, isre_motif, thresh = 1e-3) %>% 
  as.data.frame() %>% 
  merge(salmon.quant$aale$intra$deseq$de, by.x = 'seqnames', by.y = 'gene_id')
  # select(gene) %>% distinct()

irf1_fimo_results <- memes::runFimo(promoter_seqs, irf1_motif, thresh = 1e-5) %>% 
  as.data.frame() %>% 
  merge(salmon.quant$aale$intra$deseq$de, by.x = 'seqnames', by.y = 'gene_id')
  # select(gene) %>% distinct()

fos_fimo_results <- memes::runFimo(promoter_seqs, fos_motif, thresh = 1e-6) %>% 
  as.data.frame() %>% 
  merge(salmon.quant$aale$intra$deseq$de, by.x = 'seqnames', by.y = 'gene_id') 
  # select(gene) %>% distinct()

foxp2_fimo_results <- memes::runFimo(promoter_seqs, foxp2_motif, thresh = 1e-3) %>% 
  as.data.frame() %>% 
  merge(salmon.quant$aale$intra$deseq$de, by.x = 'seqnames', by.y = 'gene_id') 
  # select(gene) %>% distinct()

irf9_fimo_results <- memes::runFimo(promoter_seqs, irf9_motif, thresh = 1e-3) %>% 
  as.data.frame() %>% 
  merge(salmon.quant$aale$intra$deseq$de, by.x = 'seqnames', by.y = 'gene_id') 
  # select(gene) %>% distinct()

# fimo_results %>% as.data.frame() %>% 
#   merge(salmon.quant$aale$intra$deseq$de, by.x = 'seqnames', by.y = 'gene_id') %>% 
#   select(gene) %>% distinct()
```

```{r}
salmon.quant$aale$exo$


```

```{r}

ctrl_norm_factor <- 43576060
kras_norm_factor <- 60276212

kras_bam_path <- file.path(output.data.dir, 'narrow_output.data/bwa/mergedLibrary/kras_R1.mLb.clN.sorted.bam')

ctrl_bam_path <- file.path(output.data.dir, 'narrow_output.data/bwa/mergedLibrary/ctrl_R1.mLb.clN.sorted.bam')


salmon.quant$aale$intra$deseq$de %>% 
  filter(padj < 0.05, log2FoldChange > 1.5, gene %in% c(ifn_g, ifn_a)) %>% 
  select(gene_id) %>% unlist() %>% unname() -> de_list

# salmon.quant$aale$intra$deseq$de %>% 
#   filter(padj > 0.5) %>%  #, log2FoldChange < -1.5) %>%  #, log2FoldChange > 1.5, gene %in% c(ifn_g, ifn_a)) %>% 
#   select(gene_id) %>% unlist() %>% unname() -> ns_list

gr <- rowRanges(salmon.quant$gxi)

ifn_de_gr <- gr[names(gr) %in% de_list]

ns_gr <- gr[names(gr) %in% ns_list]

de_promoter_regions <- promoters(ifn_de_gr, upstream = 1000, downstream = 500)
ns_promoter_regions <- promoters(ns_gr, upstream = 1000, downstream = 200)

bamsignals::bamCoverage(kras_bam_path, de_promoter_regions, paired.end = 'extend') -> kras_de_prom_profile
bamsignals::bamCoverage(ctrl_bam_path, de_promoter_regions, paired.end = 'extend') -> ctrl_de_prom_profile

# bamsignals::bamCoverage(kras_bam_path, ns_promoter_regions, paired.end = 'extend') -> kras_ns_prom_profile
# bamsignals::bamCoverage(ctrl_bam_path, ns_promoter_regions, paired.end = 'extend') -> ctrl_ns_prom_profile

bamsignals::alignSignals(kras_de_prom_profile) %>% 
  as.data.frame() %>% 
  mutate(position = row_number()) %>% 
  gather(prom, cov, -position) %>%
  mutate(position = position - 1000,
         cov = (cov/kras_norm_factor) * 1e6,
         condition = 'kras',
         context = 'de') -> kras_de_prom_df

# bamsignals::alignSignals(kras_ns_prom_profile) %>% 
#   as.data.frame() %>% 
#   mutate(position = row_number()) %>% 
#   gather(prom, cov, -position) %>%
#   mutate(position = position - 1000,
#          cov = (cov/kras_norm_factor) * 1e6,
#          condition = 'kras',
#          context = 'ns') -> kras_ns_prom_df

bamsignals::alignSignals(ctrl_de_prom_profile) %>% 
  as.data.frame() %>% 
  mutate(position = row_number()) %>% 
  gather(prom, cov, -position) %>%
  mutate(position = position - 1000,
         cov = (cov/ctrl_norm_factor) * 1e6,
         condition = 'ctrl',
         context = 'de') -> ctrl_de_prom_df

# rbind(kras_de_prom_df, kras_ns_prom_df) %>% 
#   group_by(position, context) %>% 
#   summarise(ci = list(mean_cl_normal(cov))) %>% 
#   unnest(ci) %>% 
#   ggplot(aes(x = position, y = y, ymin = ymin, ymax = ymax, color = context)) + 
#   geom_ribbon() + 
#   geom_point()
  

rbind(kras_de_prom_df, ctrl_de_prom_df) %>%
  ggplot(aes(position, cov, group = condition, color = condition)) +
    stat_summary(geom="ribbon", fun.data=mean_cl_boot, width=0.1, conf.int=0.95, 
                 fill='grey', alpha = 0.1, size = rel(0.05), show.legend = F)+
    # stat_summary(geom="line", fun=mean, linetype="dashed", alpha = 0.15, size = rel(0.05)) +
    stat_summary(geom="point", fun=mean, alpha = 0.25, size = rel(1)) +
    scale_color_manual(values = c(viridis(3)[1], viridis(3)[2])) +
    xlab('distance to TSS') +
    ylab('mean CPM (95% CI)') + 
    xlim(-1000, 500) + 
    theme(legend.position = c(0.3, 0.99))

panel.save(figure = 2, name = 'isg_atac_enrichment', width = 'single', height = 'single')



# avgBinnedSig <- rowMeans(bamsignals::alignSignals(kras_prom_profile))
# 
# avgBinnedSig %>% 
#   as.data.frame() %>% 
#   rownames_to_column('bin') %>% 
#   ggplot(aes(bin, .)) + 
#   geom_col()
# 
# bamsignals::alignSignals(bamsignals::bamCoverage(kras_bam_path, promoter_regions, paired.end = 'extend')) %>% dim()
```

```{r}
salmon.quant$aale$exo$deseq$de %>% 
  dplyr::rename('EXO_aale' = log2FoldChange) %>% 
  filter(padj < 0.05) %>% 
  merge(salmon.quant$aale$intra$deseq$de %>% 
          dplyr::rename('INTRA_aale' = log2FoldChange) %>% 
          filter(padj < 0.05), by = 'gene') %>% 
  mutate(unique = ifelse(gene %in% uniq_kras_peak_genes$`Gene Name`, 'KRAS', 
                         ifelse(gene %in% uniq_ctrl_peak_genes$`Gene Name`, 'CTRL', NA))) %>% 
  ggplot(aes(EXO_aale, INTRA_aale, color = unique)) + 
  geom_point() + 
  scale_color_manual(values = c(viridis(3)[1], viridis(3)[2]), name = 'unique ATAC peak') +
  geom_hline(yintercept = 0, linetype = 'dashed', alpha = 0.4) + 
  geom_vline(xintercept = 0, linetype = 'dashed', alpha = 0.4) +
  geom_text_repel(aes(label = ifelse(abs(EXO_aale) > 1 & abs(INTRA_aale) > 1, gene, '')), show.legend = F) +
  theme(legend.position = c(0.99, 0.25)) +
  geom_line(stat = 'smooth', method = 'lm', linetype = 'dashed', alpha = 0.8, color = 'purple') +
  annotate(geom = 'text', x = 2, y = -2, 
           label = paste0('y', ' ', ' = -0.99 + 0.66x; \nadj. R2 = 0.4919'), 
           size = rel(3.75), alpha = 0.8)

salmon.quant$aale$exo$deseq$de %>% 
  dplyr::rename('EXO_aale' = log2FoldChange) %>% 
  filter(padj < 0.05) %>% 
  merge(salmon.quant$aale$intra$deseq$de %>% 
          dplyr::rename('INTRA_aale' = log2FoldChange) %>% 
          filter(padj < 0.05), by = 'gene') %>% 
  lm(EXO_aale ~ INTRA_aale, data = .) %>% 
  summary()


panel.save(figure = 3, name = 'intra_v_exo_de', width = 'single', height = 'single')


salmon.quant$aale$exo$deseq$de %>% 
  mutate(biotype = ifelse(gene %in% meta.data$gencode.35.lnc.gene.names$gene, 'lncRNA', 'coding')) %>%
  # filter(padj < 0.05) %>% 
  ggplot(aes(log2FoldChange, -log10(padj), label = gene, color = biotype)) + 
  geom_point(alpha = 0.6) + 
  scale_color_manual(values = c(viridis(3)[1], viridis(3)[2])) +
  ggrepel::geom_text_repel(aes(label = ifelse(abs(log2FoldChange) > 1, gene, '')), show.legend = F) +
  geom_vline(xintercept = 0, alpha = 0.3, linetype = 'dashed') + 
  theme(legend.position = c(0.99,0.99))

panel.save(figure = 3, name = 'exo_de', width = 'single', height = 'single')



ucsc.rmsk.salmon.quant$aale$exo$deseq$de %>%
  filter(!gene %in% meta.data$gencode.35.tx.to.gene$gene,
         padj < 0.05) %>%
  merge(meta.data$te.families.clades, by = 'gene') %>% 
  ggplot(aes(log2FoldChange, -log10(padj), label = gene, color = clade)) + 
  geom_point(alpha = 0.6) + 
  # xlim(-2, 2) +
  scale_color_viridis_d(direction = -1) +
  ggrepel::geom_text_repel(aes(label = ifelse(abs(log2FoldChange) >= 1.15, gene, '')), show.legend = F) + 
  theme(legend.position = c(0.29,0.99))

panel.save(figure = 3, name = 'exo_te_de', width = 'single', height = 'single')

  
  
  
```

```{r}
Biostrings::letterFrequency(x = seqs, letters = "GC", as.prob = TRUE)

gr[, 'GC'] <- Biostrings::letterFrequency(x = seqs, letters = "GC", as.prob = TRUE)


rowRanges(salmon.quant$gxi)[, 'gene_id' %in% 
                              filter(salmon.quant$aale$intra$deseq$de, padj < 0.01, log2FoldChange > 1)$gene]


subsetByOverlaps(rowRanges(salmon.quant$gxi), 
                 makeGRangesFromDataFrame(salmon.quant$gxi.bed %>% 
                                            filter(filter(salmon.quant$aale$intra$deseq$de, padj < 0.01,
                                                          log2FoldChange > 1)$gene)))


Biostrings::letterFrequency(x = b)

makeGRangesFromDataFrame(salmon.quant$gxi.bed %>% 
  filter(gene %in% filter(salmon.quant$aale$intra$deseq$de, padj < 0.01, log2FoldChange > 1)$gene))

```

```{r}

salmon.quant$aale$intra$deseq$de %>%
  filter(padj < 0.05, log2FoldChange > 1, gene %in% c(ifn_g, ifn_a)) %>%
  filter(gene %in% filter(salmon.quant$hbec$hbec_v12$deseq$de, padj < 0.05, log2FoldChange < -1)$gene) %>%
  select(gene) %>% unlist() %>% unname() -> de_list

hm_col_data <- 
  salmon.quant$all_intra$deseq$counts[salmon.quant$all_intra$deseq$counts$gene %in%
                                        de_list, 
                                      !grepl('intra', 
                                             colnames(salmon.quant$all_intra$deseq$counts))]
hm_count_data <- 
  salmon.quant$all_intra$deseq$counts[salmon.quant$all_intra$deseq$counts$gene %in%
                                        de_list,
                                      grepl('aale|wt2_kras_v12|wt2_lacz',
                                          colnames(salmon.quant$all_intra$deseq$counts))]

sample_col_data <- salmon.quant$all_intra$deseq$col.data %>% 
  filter(names %in% colnames(hm_count_data)) %>% 
  mutate(cell_line = names) %>% 
  separate(cell_line, sep = '[.]', into = c(NA, 'cell_line', NA, NA)) %>% 
  column_to_rownames('names')

rownames(hm_count_data) <- hm_col_data$gene

hm_count_data <- scale(t(log1p(hm_count_data)), center = T)

side_ha <- ComplexHeatmap::rowAnnotation(df = sample_col_data %>% select(cell_line), 
                                         col = list(cell_line = c('aale' = viridis(2)[1],
                                                                  'hbec' = viridis(2)[2])), show_annotation_name = F)

salmon.quant$all_intra$deseq$counts %>% 
  filter(gene %in% de_list) %>% 
  select(gene) %>% 
  mutate(FOS = ifelse(gene %in% fos_fimo_results$gene, T, F),
         ISRE = ifelse(gene %in% isre_fimo_results$gene, T, F)) %>% 
  column_to_rownames('gene') -> motif_anno_df

bottom_ha <- ComplexHeatmap::columnAnnotation(df = motif_anno_df,
                                              col = list(FOS = c('TRUE' = 'black', 'FALSE' = 'white'),
                                                         ISRE = c('TRUE' = 'black', 'FALSE' = 'white')))

set.seed(129)

ComplexHeatmap::Heatmap(hm_count_data, col = viridis(16, option = 'plasma'),
                        name = 'z-score',
                        width = panel.figure.width.double, 
                        height = panel.figure.height,
                        row_km = 2, row_title = c('WT', 'G12'),
                        use_raster = T, show_row_names = F,
                        left_annotation = side_ha,
                        bottom_annotation = bottom_ha)
  
```

```{r}
msig.df[grepl('INTERFERON', names(msig.df))] %>% 
                             unlist() %>% unname() -> ifn_gene_list

msig.df[grepl('OXIDATIVE|XENOBIOTIC', names(msig.df))] %>% 
                             unlist() %>% unname() -> metab_gene_list


salmon.quant$aale$intra$deseq$H.fgsea %>% 
  group_by(pathway) %>% 
  mutate(pathway = str_replace_all(pathway, 'HALLMARK ', ''),
         coverage = round(length(unlist(leadingEdge))/size, 3),
         NES = round(NES, 3)) %>% 
  arrange(-NES, padj) %>% 
  filter(!grepl('ZNF', pathway)) -> exp_tbl

exp_tbl %>% 
  select(pathway, padj, NES, coverage) %>% 
  mutate(padj = format(padj, scientific= T, digits = 2)) %>% 
  gridExtra::grid.table() 


salmon.quant$aale$intra$deseq$de %>% 
  mutate(padj = ifelse(padj == 0, 
                       min(filter(salmon.quant$aale$intra$deseq$de, padj != 0)$padj), padj)) %>% 
  mutate(gene_set = ifelse(gene %in% ifn_gene_list,'IFN', 'other'),
         gene_set = ifelse(gene %in% msig.df$HALLMARK_KRAS_SIGNALING_UP, 'KRAS', gene_set),
         gene_set = ifelse(gene %in% meta.data$trono.krab.znfs$gene, 'ZNF', gene_set)) %>% 
  mutate(gene_set = factor(gene_set, levels = c('KRAS','IFN','ZNF', 'other'))) %>% 
  filter(padj < 0.05) %>% 
  ggplot(aes(log2FoldChange, -log10(padj), label = gene)) + 
  geom_point(alpha = 0.6) + 
  ggrepel::geom_text_repel(aes(label = ifelse(abs(log2FoldChange) > 5 & gene_set != 'other' | 
                                                padj < 0.0001 & gene_set != 'other', gene, ''))) +
  facet_col(~gene_set, scales = 'free_y') +
  geom_vline(xintercept = 0, alpha = 0.3, linetype = 'dashed')

panel.save(figure = 1, name = 'facet_set_volcano', width = 'single', height = 'double')

salmon.quant$hbec$lacz_v_v12$deseq$de %>% 
   filter(padj < 0.05, log2FoldChange > 1) %>% 
   select(gene) %>% unlist() %>% unname() -> hbec_up


# salmon.quant$hbec$lacz_v_v12$deseq$de %>% 
salmon.quant$aale$intra$deseq$de %>% 
  mutate(cell_line = 'AALE') %>% 
  rbind(salmon.quant$hbec$lacz_v_v12$deseq$de %>% 
    mutate(cell_line = 'HBEC')) %>% 
  filter(padj < 0.05) %>% 
  filter(gene %in% c(ifn_a, ifn_g)) %>% 
  mutate(IRF9 = ifelse(gene %in% irf9_fimo_results$gene, T, F)) %>%
  ggplot(aes(IRF9, log2FoldChange)) + 
  geom_boxplot(outlier.colour = NA, fill = NA) +
  geom_jitter(alpha = 0.4, width = 0.15) +
  facet_col(~cell_line, scales = 'free_y') +
  # geom_text_repel(aes(label = ifelse(abs(log2FoldChange) > 1, gene, ''))) +
  stat_compare_means(label.x.npc = 0.55, label.y.npc = 0.03) + 
  xlab('IRF9 motif')
  
panel.save(figure = 1, name = 'facet_set_irf9_expression', width = 'single', height = 'single')


salmon.quant$aale$intra$deseq$de %>% 
  dplyr::rename('AALE' = log2FoldChange) %>% 
  filter(padj < 0.05,
         gene %in% c(ifn_a, ifn_g)) %>% 
  merge(salmon.quant$hbec$lacz_v_v12$deseq$de %>% 
          dplyr::rename('HBEC' = log2FoldChange) %>% 
          filter(padj < 0.05) %>% 
          mutate(HBEC = HBEC), by = 'gene') %>% 
  mutate(ISRE = ifelse(gene %in% irf9_fimo_results$gene, T, F)) %>% 
  ggplot(aes(AALE, HBEC, color = ISRE)) + 
  geom_point() + 
  scale_color_manual(values = c(viridis(3)[1], viridis(3)[2])) +
  geom_hline(yintercept = 0, linetype = 'dashed', alpha = 0.4) + 
  geom_vline(xintercept = 0, linetype = 'dashed', alpha = 0.4) +
  geom_text_repel(aes(label = ifelse(AALE > 1 & HBEC > 1, gene, '')), show.legend = F) + 
  theme(legend.position = c(0.99, 0.92))
  
  salmon.quant$aale$intra$deseq$de %>% 
  dplyr::rename('AALE' = log2FoldChange) %>% 
  filter(padj < 0.05,
         gene %in% c(ifn_a, ifn_g)) %>% 
  merge(salmon.quant$hbec$lacz_v_v12$deseq$de %>% 
          dplyr::rename('HBEC' = log2FoldChange) %>% 
          filter(padj < 0.05) %>% 
          mutate(HBEC = HBEC), by = 'gene') %>% 
    lm(AALE ~ HBEC, data = .) %>% summary()


panel.save(figure = 1, name = 'de_scatter_ifn', width = 'single', height = 'single')



```

```{r}
toil.survival <- read_tsv(file.path(output.data.dir, 'tcga.data/TCGA-LUAD.survival.tsv.gz')) 
luad.phenotypes <- 
  read_tsv(file.path(output.data.dir, 'tcga.data/TCGA-LUAD.GDC_phenotype.tsv.gz')) %>% 
  select(sample = submitter_id.samples, 
       sample_type = sample_type.samples,
       stage = tumor_stage.diagnoses,
       age = age_at_index.demographic,
       sex = gender.demographic,
       race = race.demographic)
luad.mutect <- read_tsv(file.path(output.data.dir, 'tcga.data/TCGA-LUAD.mutect2_snv.tsv.gz')) %>% 
  filter(gene %in% c('KRAS')) %>% 
  select(sample = Sample_ID, gene, aa_change = Amino_Acid_Change) %>% 
  pivot_wider(names_from = gene, values_from = aa_change) %>% 
  mutate(across(.cols = where(is.list), paste)) 

luad.phenotypes.merge <- luad.phenotypes %>% 
  merge(luad.mutect, by = 'sample', all.x = T) %>% 
  filter(sample_type %in% c('Primary Tumor', 'Solid Tissue Normal')) %>% 
  merge(toil.survival, by = 'sample') %>% 
  mutate(sample = str_sub(sample, end = str_length(sample) - 1)) %>% 
  replace_na(list(KRAS = 'WT')) %>% 
  mutate(KRAS = ifelse(sample_type == 'Solid Tissue Normal', 'WT_normal', KRAS))

norm.counts.final <- read_tsv(file.path(output.data.dir, 'tcga.data', 'luad.data.frame.tsv'))
```

```{r}

norm.counts.final %>% 
  filter(sample != 'TCGA-44-3917-01') %>% 
  filter(KRAS %in% c('p.G12D', 'p.G12C', 'p.G12V', 'WT_normal')) -> working_toil_counts

salmon.quant$aale$intra$deseq$de %>% 
  filter(padj < 0.05, log2FoldChange > 3.5, gene %in% c(ifn_a, ifn_g)) -> aale_ifn

working_toil_counts %>% 
  # filter(gene %in% c('ISG20', 'ISG15', 'MX2', 'CFB', 'IFITM1', 'OAS1', 'MOV10', 'OAS3')) %>%
  filter(gene %in% uniq_peak_genes$`Gene Name`) %>% 
  # filter(gene %in% aale_ifn$gene) %>%
  group_by(gene) %>%
  mutate(count = scale(log1p(count), center = T)) %>%
  select(sample, gene, count) %>%
  pivot_wider(names_from = gene, values_from = count) %>%
  distinct() %>% 
  column_to_rownames('sample') %>% 
  t() -> toil_hm_counts

working_toil_counts %>% 
  select(sample, 'G12D' = KRAS) %>%
  distinct() %>% 
  column_to_rownames('sample') %>% 
  ComplexHeatmap::rowAnnotation(df = . , 
                                   col = list(G12D = c('WT_normal' = 'white', 
                                                       'p.G12D' = viridis(3)[2])),
                                   show_legend = F,
                                annotation_name_side = 'bottom',
                                simple_anno_size = unit(2.5, "mm")) -> toil_sample_anno

working_toil_counts %>% 
  select(sample, 'G12' = KRAS) %>%
  distinct() %>% 
  column_to_rownames('sample') %>% 
  ComplexHeatmap::rowAnnotation(df = . , 
                                   col = list(G12D = c('WT_normal' = 'white', 
                                                       'p.G12' = viridis(3)[2])),
                                   show_legend = F,
                                annotation_name_side = 'bottom',
                                simple_anno_size = unit(2.5, "mm")) -> toil_sample_anno



working_toil_counts %>% 
  # filter(gene %in% c('ISG20', 'ISG15', 'MX2', 'CFB', 'IFITM1', 'OAS1', 'MOV10', 'OAS3')) %>%
  filter(gene %in% uniq_peak_genes$`Gene Name`) %>% 
  # filter(gene %in% aale_ifn$gene) %>%
  select(gene) %>% 
  distinct() %>% 
  mutate(IRF9 = ifelse(gene %in% irf9_fimo_results$gene, T, F)) %>% 
  column_to_rownames('gene') %>% 
  ComplexHeatmap::columnAnnotation(df =.,
                                col = list(IRF9 = c('TRUE' = viridis(2)[1], 'FALSE' = 'white')),
                                show_legend = F,
                                annotation_name_side = 'right',
                                simple_anno_size = unit(2.5, "mm")) -> gene_motif_anno




ComplexHeatmap::Heatmap(t(toil_hm_counts), 
                        name = 'z-score', 
                        show_row_names = F,
                        left_annotation = toil_sample_anno,
                        bottom_annotation = gene_motif_anno,
                        # heatmap_width = unit(panel.figure.width, 'mm'),
                        # heatmap_height = unit(panel.figure.height/2, 'mm'),
                        # column_dend_height = unit(3, 'mm'),
                        # row_dend_width = unit(4.5, 'mm'),
                        height = unit((panel.figure.height/2)/1.325, 'mm'),
                        width = unit((panel.figure.width)/1.645, 'mm')) #-> toil_hm_plt

size = calc_ht_size(toil_hm_plt)
size

pdf(file = file.path(figure.dir, 'fig.1', 'toil_hm.pdf'),
    width=unit(size[1], 'mm'), height=unit(size[2], 'mm'), family = 'Helvetica')

toil_hm_plt

dev.off()

# save_pheatmap_pdf(x = toil_hm, filename = 'test_hm.pdf', height = panel.figure.height/2, width = panel.figure.width)


working_toil_counts %>% 
  filter(gene %in% c('ISG20', 'ISG15', 'MX2', 'CFB', 'IFITM1', 'OAS1', 'MOV10', 'OAS3')) %>%
  ggplot(aes(KRAS, count)) + 
  geom_boxplot(outlier.colour = NA, fill = NA) +
  geom_point() + 
  facet_wrap(~gene) + 
  stat_compare_means(comparisons = list(c('p.G12D', 'WT_normal')), method = 'wilcox')
```

```{r}
myc.avg.counts.tidy.stratified <-
  norm.counts.final %>%
  filter(sample_type == 'Primary Tumor') %>%
  # filter(gene %in% tmp.df$gene) %>%
  filter(gene %in% c('ISG20', 'ISG15', 'MX2', 'CFB', 'IFITM1', 'OAS1', 'MOV10', 'OAS3')) %>%
  select(sample, count) %>% 
  group_by(sample) %>%
  summarize(avg.count = mean(count)) %>%
  mutate(gene.set = 'toil_ifn') %>%
  group_by(gene.set) %>%
  mutate(stratum = ifelse(avg.count >= quantile(avg.count, 0.66),
                          'top-third', ifelse(avg.count <= quantile(avg.count, 0.33),
                                              'bottom-third', 'middle'))) %>%
  filter(stratum != 'middle') %>%
  spread(gene.set, stratum)

surv.obj <- Surv(time = filter(luad.phenotypes.merge %>% select(sample, OS.time, OS) %>% distinct() , 
                               sample %in% myc.avg.counts.tidy.stratified$sample)$OS.time,
                 event = filter(luad.phenotypes.merge %>% select(sample, OS.time, OS) %>% distinct(), 
                                sample %in% myc.avg.counts.tidy.stratified$sample)$OS)

surv.fit <- survfit(as.formula(surv.obj ~ myc.avg.counts.tidy.stratified$toil_ifn), 
                    data = myc.avg.counts.tidy.stratified)
ggsurvplot(surv.fit,
           pval = T, 
           legend.title = "",
           ggtheme = theme_set_fun() + theme(legend.position = c(0.45,0.95)),
           pval.coord = c(0, 0.08),
           palette = viridis(3)[c(2,1)])
surv.plt

```



###A549
```{r}
ggplot(ucsc.rmsk.salmon.quant$a549$deseq$de %>% 
         merge(salmon.quant$aale$deseq$de, by = 'gene') %>% 
         filter(gene %in% gencode.35.lnc.gene.names$gene), 
       aes(log2FoldChange.x,log2FoldChange.y, label = gene)) + 
  geom_point() + 
  geom_hline(yintercept = 0, linetype = 'dotted') + 
  geom_vline(xintercept = 0, linetype = 'dotted') + 
  ggrepel::geom_text_repel()


ucsc.rmsk.salmon.quant$a549$deseq$counts %>% 
  filter(grepl('^Alu', gene)) %>% 
  gather(sample, counts)
  column_to_rownames('gene') %>% 
  pheatmap()
```


## ATAC
```{r}
kras_atac_anno_peaks <- 
  read_tsv(file.path(output.data.dir, 
                     'narrow_output.data/bwa/mergedLibrary/macs/narrowPeak/kras_R1.mLb.clN_peaks.annotatePeaks.txt'))

ctrl_atac_anno_peaks <- 
  read_tsv(file.path(output.data.dir, 
                     'narrow_output.data/bwa/mergedLibrary/macs/narrowPeak/ctrl_R1.mLb.clN_peaks.annotatePeaks.txt'))

consensus_atac_anno_peak_counts <- 
  read_tsv(file.path(output.data.dir, 
                     'narrow_output.data/bwa/mergedLibrary/macs/narrowPeak/consensus/consensus_peaks.mLb.clN.featureCounts.txt'),
           skip = 1)

consensus_atac_boolean_anno <- 
  read_tsv(file.path(output.data.dir, 
                     'narrow_output.data/bwa/mergedLibrary/macs/narrowPeak/consensus/consensus_peaks.mLb.clN.boolean.annotatePeaks.txt'
                     ))


irf9_fimo_results %>% 
  mutate(start.x = start.y + start.x,
         end.x = start.y + end.x) %>% 
  select(chr, start = start.x, end = end.x, strand = strand.x, gene, motif_id) %>% 
  unite(col = 'name', sep = '_', c(gene, motif_id)) %>% 
  makeGRangesFromDataFrame(keep.extra.columns = T) -> irf9_bed

consensus_atac_anno_peak_counts %>% 
  select(chr = Chr, start = Start, end = End, strand = Strand, name = Geneid) %>% 
  makeGRangesFromDataFrame(keep.extra.columns = T) -> consensus_bed

consensus_atac_boolean_anno %>% 
  filter(ctrl_R1.mLb.clN.bool == F) %>% 
  select(chr, start, end, name = interval_id) %>% 
  makeGRangesFromDataFrame(keep.extra.columns = T) -> kras_atac_bed

consensus_atac_boolean_anno %>% 
  filter(ctrl_R1.mLb.clN.bool == F) %>% 
  # filter(`Gene Name` %in% filter(salmon.quant$aale$intra$deseq$de, padj < 0.05, log2FoldChange > 1.5)$gene) %>%
  # filter(`Gene Name` %in% c(ifn_g, ifn_a)) %>%
  separate(Annotation, sep = '\\(', into = c('annotation', NA)) %>% 
  filter(annotation == "promoter-TSS ") %>%
  # group_by(annotation) %>%
  group_by(`Gene Name`) %>%
  tally() -> uniq_kras_peak_genes#%>% filter(grepl('ZNF', `Gene Name`)) %>% 
  # arrange(-n)

consensus_atac_boolean_anno %>% 
  filter(kras_R1.mLb.clN.bool == F) %>% 
  # filter(`Gene Name` %in% filter(salmon.quant$aale$intra$deseq$de, padj < 0.05, log2FoldChange > 1.5)$gene) %>%
  # filter(`Gene Name` %in% c(ifn_g, ifn_a)) %>%
  separate(Annotation, sep = '\\(', into = c('annotation', NA)) %>% 
  filter(annotation == "promoter-TSS ") %>%
  # group_by(annotation) %>%
  group_by(`Gene Name`) %>%
  tally() -> uniq_ctrl_peak_genes



consensus_atac_boolean_anno %>% 
  filter(ctrl_R1.mLb.clN.bool == F) %>% 
  filter(`Gene Name` %in% filter(salmon.quant$aale$intra$deseq$de, padj < 0.05, log2FoldChange > 1.5)$gene) %>%
  filter(`Gene Name` %in% c(ifn_g, ifn_a)) %>%
  separate(Annotation, sep = '\\(', into = c('annotation', NA)) %>% 
  filter(annotation == "promoter-TSS ") %>% 
  mutate(strand = '+') %>% 
  select(chr, start, end, strand, name = `Gene Name`) %>% 
  GenomicRanges::makeGRangesFromDataFrame() -> ifn_uniq_peak_ranges

names(ifn_uniq_peak_ranges) <- uniq_peak_genes$`Gene Name`

consensus_atac_boolean_anno %>% 
  filter(ctrl_R1.mLb.clN.bool == F) %>% 
  filter(`Gene Name` %in% filter(salmon.quant$aale$intra$deseq$de, padj < 0.05, log2FoldChange > 1.5)$gene) %>%
  filter(!`Gene Name` %in% c(ifn_g, ifn_a), ! is.na(`Gene Name`)) %>%
  separate(Annotation, sep = '\\(', into = c('annotation', NA)) %>% 
  filter(annotation == "promoter-TSS ") %>% 
  mutate(strand = '+') %>% 
  select(chr, start, end, strand, name = `Gene Name`) %>% 
  GenomicRanges::makeGRangesFromDataFrame() -> other_uniq_peak_ranges

names(other_uniq_peak_ranges) <- consensus_atac_boolean_anno %>% 
                                  filter(ctrl_R1.mLb.clN.bool == F) %>% 
                                  filter(`Gene Name` %in%
                                           filter(salmon.quant$aale$intra$deseq$de, padj < 0.05, log2FoldChange > 1.5)$gene) %>%
                                  filter(!`Gene Name` %in% c(ifn_g, ifn_a), ! is.na(`Gene Name`)) %>% 
  separate(Annotation, sep = '\\(', into = c('annotation', NA)) %>% 
  filter(annotation == "promoter-TSS ") %>% 
  select(`Gene Name`) %>% unlist() %>% unname()

getSeq(BSgenome.Hsapiens.UCSC.hg38, ifn_uniq_peak_ranges) -> ifn_uniq_seqs
getSeq(BSgenome.Hsapiens.UCSC.hg38, other_uniq_peak_ranges) -> other_uniq_seqs

memes::runAme(input = ifn_uniq_seqs, control = other_uniq_seqs) -> ifn_uniq_motifs

salmon.quant$aale$intra$deseq$de %>% 
  filter(padj < 0.05, abs(log2FoldChange) > 1) %>%
  select(gene_id) %>% unlist() %>% unname() -> de_list

de_list_ranges <- gr[names(gr) %in% de_list]

names(de_list_ranges) <- paste0(seqnames(de_list_ranges), '_', names(de_list_ranges))

de_list_promoter_seqs <-
  GenomicFeatures::getPromoterSeq(subject = BSgenome.Hsapiens.UCSC.hg38, 
                                  query = de_list_ranges, upstream = 1000, downstream = 500)

lapply(ifn_uniq_motifs$motif_id, function(motif) {
  
  print(motif)
  
  this_motif <- MotifDb::query(MotifDb::MotifDb, motif) %>% 
                  universalmotif::convert_motifs()
  
  memes::runFimo(de_list_promoter_seqs, motifs = this_motif) -> de_list_promoter_regions
  
  bamsignals::bamCount(kras_bam_path,
                          de_list_promoter_regions) -> kras_de_prom_profile

  bamsignals::bamCount(ctrl_bam_path,
                          de_list_promoter_regions) -> ctrl_de_prom_profile

  lst('kras' = kras_de_prom_profile,
      'ctrl' = ctrl_de_prom_profile)
  

}) -> de_list_fimo_out

de_list_fimo_out[[4]]$kras





  
```


## FUN: Single Cell
```{r}
library(Seurat)
library(tximeta)
library(tximport)

tximeta::loadLinkedTxome(file.path(reference.dir, "gencode.v35.salmon_docker.json"))


kras_alevin <- file.path(output.data.dir, 
                         'alevin_kras.fastq_sel.align.gencode.v35.salmon.v1.3.0.sidx',
                         'alevin/quants_mat.gz')
ctrl_alevin <- file.path(output.data.dir, 
                         'alevin_ctrl.fastq_sel.align.gencode.v35.salmon.v1.3.0.sidx',
                         'alevin/quants_mat.gz')
d14_alevin <- file.path(output.data.dir, 
                         'alevin_aale.day14_sel.align.gencode.v35.salmon.v1.3.0.sidx',
                         'alevin/quants_mat.gz')

kras_alevin_txi <- tximport(kras_alevin, type = 'alevin', alevinArgs=list(filterBarcodes=TRUE))
ctrl_alevin_txi <- tximport(ctrl_alevin, type = 'alevin', alevinArgs=list(filterBarcodes=TRUE))
d14_alevin_txi <- tximport(d14_alevin, type = 'alevin', alevinArgs=list(filterBarcodes=TRUE))


```
###
```{r}
kras_alevin_sc <- 
  Seurat::CreateSeuratObject(counts = kras_alevin_txi$counts, min.cells = 3, min.features = 200, project = 'kras')
ctrl_alevin_sc <- 
  Seurat::CreateSeuratObject(counts = ctrl_alevin_txi$counts, min.cells = 3, min.features = 200, project = 'ctrl')
d14_alevin_sc <- 
  Seurat::CreateSeuratObject(counts = d14_alevin_txi$counts, min.cells = 3, min.features = 200, project = 'd14')
```
###
```{r}
aale_sc <- merge(kras_alevin_sc, 
                 ctrl_alevin_sc, 
                 add.cell.ids=c('aale_kras', 'aale_ctrl'))

aale_sc <- merge(d14_alevin_sc, aale_sc)

# aale_sc <- kras_alevin_sc


aale_sc <- merge(kras_alevin_sc, y = c(ctrl_alevin_sc, d14_alevin_sc), 
                 add.cell.ids = c('aale_stable_kras', 'aale_ctrl', 'aale_d14_kras'), 
                 project = "aale")
aale_sc

table(aale_sc$orig.ident)

```
###
```{r}
aale_sc[["percent.mt"]] <- PercentageFeatureSet(aale_sc, pattern = "^MT-")

aale_sc[["percent.KRAS"]] <- PercentageFeatureSet(aale_sc, pattern = "KRAS", assay = 'RNA')

# plot1 <- FeatureScatter(aale_sc, feature1 = "nCount_RNA", feature2 = "percent.mt")
# plot2 <- FeatureScatter(aale_sc, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
# plot2
```
###
```{r}
VlnPlot(aale_sc, features = c("nFeature_RNA", "nCount_RNA", "percent.mt","percent.KRAS"), ncol = 4)
aale_sc <- subset(aale_sc, subset = nFeature_RNA >= 2000 & percent.mt < 10) #& percent.KRAS > 0.00)
# aale_sc <- subset(aale_sc, subset = nFeature_RNA > 1000 & percent.mt < 10) #& percent.KRAS > 0.00)

VlnPlot(aale_sc, features = c("nFeature_RNA", "percent.KRAS", "percent.mt"), ncol = 3)
aale_sc <- NormalizeData(aale_sc)
```
###
```{r}
set.seed(123)
aale_sc <- FindVariableFeatures(aale_sc, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(aale_sc), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(aale_sc)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot2
```
###
```{r}
all.genes <- rownames(aale_sc)
aale_sc <- ScaleData(aale_sc, features = all.genes)
# aale_sc <- ScaleData(aale_sc, features = salmon.quant$aale$deseq$de$gene)
```
###
```{r}
aale_sc <- RunPCA(aale_sc, features = VariableFeatures(object = aale_sc))

# aale_sc <- RunPCA(aale_sc, features = salmon.quant$aale$deseq$de$gene)

# Examine and visualize PCA results a few different ways
print(aale_sc[["pca"]], dims = 1:5, nfeatures = 5)

# VizDimLoadings(aale_sc, dims = 1:8, reduction = "pca")

DimPlot(aale_sc, reduction = "pca")

DimHeatmap(aale_sc, dims = 1:4, cells = 500, balanced = TRUE)
```
###
```{r}
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes

aale_sc_cc <- CellCycleScoring(aale_sc, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)
RidgePlot(aale_sc_cc, features = c("PCNA", "TOP2A", "MCM6", "MKI67"), ncol = 2)

aale_sc_cc <- RunPCA(aale_sc_cc, features = c(s.genes, g2m.genes))
DimPlot(aale_sc_cc, group.by = 'orig.ident')

```
###
```{r}
aale_sc <- JackStraw(aale_sc, num.replicate = 100, dims = 40)
aale_sc <- ScoreJackStraw(aale_sc, dims = 1:40)
```
###
```{r}
JackStrawPlot(aale_sc, dims = 1:40)
```
###
```{r}
dims = 30

# dims = 10
set.seed(123)
aale_sc <- FindNeighbors(aale_sc, dims = 1:dims)
aale_sc <- FindClusters(aale_sc, resolution = 0.8)
```
###
```{r}
set.seed(123)

aale_sc <- RunUMAP(aale_sc, dims = 1:dims, n.neighbors = 5)

DimPlot(aale_sc, reduction = "umap", group.by = 'orig.ident') /
DimPlot(aale_sc, reduction = "umap", label = T) /
FeaturePlot(aale_sc, features = c('KRAS', 'ISG15')) + theme_set_fun()
```
####
```{r}

```

###
```{r}
set.seed(123)

aale.markers <- FindAllMarkers(aale_sc, only.pos = F, min.pct = 0.25, logfc.threshold = 0.5)
aale.markers %>%
    group_by(cluster) %>%
    filter(p_val_adj < 0.05) -> aale.markers

View(aale.markers %>% merge(salmon.quant$aale$deseq$de, by = 'gene'))

aale.markers %>% merge(salmon.quant$aale$deseq$de, by = 'gene') %>% 
  filter(gene %in% msig.df.all$HALLMARK_INTERFERON_ALPHA_RESPONSE) %>%
  ggplot(aes(log2FoldChange, avg_log2FC, label = gene)) + 
  geom_point() + 
  geom_hline(yintercept = 0, color = 'grey', linetype = 'dotted') + 
  geom_vline(xintercept = 0, color = 'grey', linetype = 'dotted') + 
  # geom_smooth(method = 'lm') +
  ggrepel::geom_text_repel() +
  facet_row(~cluster)

aale.markers %>% 
  dplyr::select(gene, avg_log2FC, cluster) %>% 
  merge(salmon.quant$aale$deseq$de, by = 'gene') %>%
  group_by(cluster) %>% 
  do(broom::glance(lm(data=., formula = log2FoldChange ~ avg_log2FC))) -> aale.markers.model


aale.markers.model %>% 
  ggplot(aes(reorder(cluster, -adj.r.squared), adj.r.squared)) + 
  geom_point()

aale.markers %>% 
  dplyr::select(gene, avg_log2FC, cluster) %>% 
  merge(salmon.quant$aale$deseq$de, by = 'gene') %>%
  group_by(cluster) %>% 
  do(broom::tidy(lm(data=., formula = log2FoldChange ~ avg_log2FC))) %>% 
  filter(term == 'avg_log2FC') -> aale.markers.model

FindMarkers(aale_sc, ident.1 = 6, #ident.2 = c(3),
# FindMarkers(aale_sc, ident.1 = 3,# ident.2 = c(8,0,6),
            min.pct = 0.25, logfc.threshold = 0.25, only.pos = F) %>% 
  filter(p_val_adj < 0.05) %>% 
  rownames_to_column('gene') %>% 
  mutate(rank = -log(p_val + 1) * sin(avg_log2FC),
         rank = scale(rank),
         gene = as.character(gene)) -> clust.8.de

summary(lm(data=clust.8.de %>% merge(salmon.quant$aale$deseq$de, by = 'gene'), 
           formula = log2FoldChange ~ avg_log2FC))

clust.8.de %>% 
  merge(salmon.quant$aale$deseq$de, by = 'gene') %>% 
  ggplot(aes(avg_log2FC, log2FoldChange)) + 
  geom_point() + 
  geom_text_repel(aes(label = gene)) + 
  geom_hline(yintercept = 0, color = 'grey', linetype = 'dotted') + 
  geom_vline(xintercept = 0, color = 'grey', linetype = 'dotted') + 
  geom_smooth(method = 'lm', state = 'line')

clust.8.rnk <- 
    ctrl_v_d14.markers$rank
clust.8.rnk <- 
  setNames(ctrl_v_d14.markers$rank, ctrl_v_d14.markers$gene)

# run the GSEA implementation on the hallmark sets supplemented with custom sets
print('fgsea')
de.seq.fgsea.res <- 
  fgsea(pathways = msig.df, 
        stats = clust.8.rnk, eps = 0.0)

print('padj filter and clean names')
# convert to a tidy format, clean the names for display
de.seq.fgsea.df <-
  as_tibble(de.seq.fgsea.res) %>%
  # filter(padj <= 0.05) %>%
  mutate(pathway = gsub('_', ' ', pathway))

FindMarkers(aale_sc, ident.1 = 3, ident.2 = c(8,0,6), 
            min.pct = 0.25, logfc.threshold = 0.25, only.pos = T) %>% 
  filter(p_val_adj < 0.05) %>% 
  mutate(rank = scale(p_val_adj * sin(avg_log2FC))) -> clust.3.rnk

FindMarkers(aale_sc, ident.1 = 2, ident.2 = c(5,4), 
            min.pct = 0.25, logfc.threshold = 0.5, only.pos = T) %>% 
  filter(p_val_adj < 0.05) %>% 
  head()



DoHeatmap(aale_sc, features = filter(aale.markers, avg_log2FC >= 1)$gene)

FindMarkers(aale_sc, ident.1 = c(1,3,6,7), ident.2 = c(0,2,4,5), min.pct = 0.25, 
            logfc.threshold = 0.25, only.pos = F) %>% 
            mutate(rank = -log(p_val + 1) * sin(avg_log2FC),
                   rank = scale(rank)) -> ctrl_v_d14.markers

FindMarkers(aale_sc, ident.1 = c(1,3,6,7), ident.2 = c(0,2,4,5), min.pct = 0.25, 
            logfc.threshold = 0.25, only.pos = F) %>% 
            mutate(rank = -log(p_val + 1) * sin(avg_log2FC),
                   rank = scale(rank)) -> ctrl_v_stable.markers

is.data.frame(salmon.quant$aale$deseq$de)

ctrl_v_stable.markers %>%
  rownames_to_column('gene') %>% 
  merge(salmon.quant$aale$deseq$de, by = 'gene') %>% 
  filter(gene %in% msig.df$HALLMARK_INTERFERON_GAMMA_RESPONSE) %>%
  ggplot(aes(log2FoldChange, avg_log2FC, label = gene)) + 
  geom_point() + 
  ggrepel::geom_text_repel() + 
  geom_hline(yintercept = 0, linetype = 'dotted') +
  geom_vline(xintercept = 0, linetype = 'dotted') + 
  geom_smooth(method = 'lm', se = F, alpha = 0.4) + 
  xlab('BULK') + ylab('SC')

FindMarkers(aale_sc, ident.1 = 3, ident.2 = c(2,1), min.pct = 0.25, logfc.threshold = 0.5, only.pos = T) %>% head()

FindMarkers(aale_sc, ident.1 = 5, ident.2 = c(0,4), min.pct = 0.25, logfc.threshold = 0.5, only.pos = T) %>% head()
FindMarkers(aale_sc, ident.1 = 4, ident.2 = c(0,5), min.pct = 0.25, logfc.threshold = 0.5, only.pos = T) %>% head()
FindMarkers(aale_sc, ident.1 = 5, ident.2 = c(3), min.pct = 0.125, logfc.threshold = 0.5, only.pos = F) -> tmp.df
```
### tidying normalized counts
```{r}
# extract scaled, normalized counts
aale_sc_norm_counts <- as.data.frame(as.matrix(aale_sc[["RNA"]]@data))
# extract barcodes
aale_sc_barcode_counts <- 
  as.data.frame(as.matrix(aale_sc@meta.data)) %>% 
  rownames_to_column('barcode')

# tidy 
aale_sc_norm_counts_tidy <-
  aale_sc_norm_counts %>% 
  rownames_to_column('gene') %>% 
  gather(barcode, norm.counts, -gene) 

aale_sc_norm_counts_t <- as.data.frame(t(aale_sc_norm_counts))


aale_sc_norm_counts_t_kras <- 
  aale_sc_norm_counts_t %>% 
  rownames_to_column('barcode') %>% 
  filter(grepl('kras', barcode)) %>% 
  column_to_rownames('barcode')


aale_sc_norm_counts_t_ctrl <- 
  aale_sc_norm_counts_t %>% 
  rownames_to_column('barcode') %>% 
  filter(grepl('ctrl', barcode)) %>% 
  column_to_rownames('barcode')

aale_sc_norm_counts_t_kras_corr <- corrr::correlate(aale_sc_norm_counts_t_kras)

aale_sc_norm_counts_t_ctrl_corr <- corrr::correlate(aale_sc_norm_counts_t_ctrl) 


aale_sc_norm_counts_t_corr <- corrr::correlate(aale_sc_norm_counts_t)

aale_sc_norm_counts_t_kras_corr %>% 
  dplyr::select(term, KRAS) -> aale_sc_norm_counts_t_corr_kras

aale_sc_norm_counts_t_corr_kras %>% 
  top_n(20, abs(KRAS)) %>%
  arrange(-KRAS) %>% 
  merge(salmon.quant$aale$deseq$de, by.x = 'term', by.y = 'gene') %>% 
  ggplot(aes(log2FoldChange, KRAS, label = term)) + 
  geom_point() + 
  geom_hline(yintercept = 0, linetype = 'dotted') +
  geom_vline(xintercept = 0, linetype = 'dotted') + 
  ggrepel::geom_text_repel()

# pair barcodes and counts
# aale_sc_norm_counts_tidy_merge <- 
#   merge(aale_sc_norm_counts_tidy, aale_sc_barcode_counts, by = 'barcode')
```
### Calculate gene sets within the suerat counts matrix:
```{r}
## using seurat wrappers for GGPLOT functions to visualize the means of gene sets on a per cell/per cluster basis
# make a copy so we don't overwrite everything above accidentallu
gene.set.kras.aale.sc <- aale_sc  

kras.isg.signature <- c("DDX58", "IFIH1", "IFNL1", "IRF9", "IFI27", "OAS2", "IFIT3", "IFIT1", "OASL", "ISG15", "OAS3", "RSAD2", "MX1", "OAS1", "IFI44", "CH25H", "IFIT2", "ISG20", "RNASEL", "IFI6", "HERC5", "HERC6", "GBP3", "GBP1", "IRF1", "ISG15")

liu.isg.signature <- c('ADAR', 'DDX60', 'HERC6', 'IRF7', 'OASL', 'PSM2', 'STAT2', 'TRIM25', 'BST2', 'DHX58', 'IFI35',
                       'ISG15', 'OGFR', 'RSAD2', 'TDRD7', 'UBE2L6', 'CASP1', 'EIF2AK2', 'IFIH1', 'ISG20', 'PARP12',
                       'RTP4', 'TRAFD1', 'USP18', 'CMPK2', 'EPSTI1', 'IFIT2', 'MX1', 'PARP14', 'SAMD9L', 'TRIM14',
                       'CXCL10', 'GBP4', 'IFIT3', 'NMI', 'PNPT1', 'SP110', 'TRIM21')

kras.gene.signature <- c('KRAS', 'B2M', 'HLA-A', 'HLA-B', 'ISG15')


msig.df.all$KEGG_MAPK_SIGNALING_PATHWAY %>% 
  as.data.frame() %>% #filter(`.` %in% salmon.quant$aale$deseq$de$gene) %>% 
  unique() %>% rename_(gene = '.') -> mapk.signal.pathway

salmon.quant$aale$deseq$H.fgsea %>% 
  filter(pathway == 'HALLMARK EPITHELIAL MESENCHYMAL TRANSITION') %>% 
  dplyr::select(leadingEdge) %>% unlist() -> msig.h.emt

salmon.quant$aale$deseq$H.fgsea %>% 
  filter(pathway == 'HALLMARK KRAS SIGNALING UP') %>% 
  dplyr::select(leadingEdge) %>% unlist() -> msig.h.kras.signal.up

msig.df$HALLMARK_INTERFERON_ALPHA_RESPONSE %>% 
  as.data.frame() %>% filter(`.` %in% salmon.quant$aale$deseq$de$gene) %>% 
  unique() %>% rename_(gene = '.') ->msig.df.h.ifna

msig.df$HALLMARK_KRAS_SIGNALING_UP %>% 
  as.data.frame() %>% #filter(`.` %in% salmon.quant$aale$deseq$de$gene) %>% 
  unique() %>% rename_(gene = '.') ->kras.signal.up

aale.up <- filter(salmon.quant$aale$deseq$de, log2FoldChange > 1)$gene
# add the gene set as an attribute of the single cell object (requires the SCexperiment library)
add.gene.set.to.sc <- function(gene.set, name){
  gene.set <- 
    rownames(gene.set.kras.aale.sc[['RNA']]@data)[rownames(gene.set.kras.aale.sc[['RNA']]@data) %in% gene.set]
  
  # Get mean expression of genes of interest per cell
  mean.exp <- 
    colMeans(x = gene.set.kras.aale.sc[['RNA']]@data[rownames(gene.set.kras.aale.sc[['RNA']]@data) %in% gene.set, ], 
             na.rm = TRUE)
  # Add mean expression values in 'object@meta.data$gene.set.score'
  name <- deparse(substitute(name))
  gene.set.kras.aale.sc@meta.data[, `name`] <- mean.exp 
  return(gene.set.kras.aale.sc)
}

# need to pass the name like this in order to use it as a string...unless I overcomplicated things
# gene.set.kras.aale.sc <- add.gene.set.to.sc(liu.isg.signature, `liu.isg.signature`)
# gene.set.kras.aale.sc <- add.gene.set.to.sc(kras.isg.signature, `kras.isg.signature`)
gene.set.kras.aale.sc <- add.gene.set.to.sc(msig.df.h.ifna$gene, `msig.df.h.ifna`)
# gene.set.kras.aale.sc <- add.gene.set.to.sc(msig.df.h.ifng, `msig.df.h.ifng`)
gene.set.kras.aale.sc <- add.gene.set.to.sc(kras.signal.up$gene, `kras.signal.up`)
gene.set.kras.aale.sc <- add.gene.set.to.sc(mapk.signal.pathway$gene, `mapk.signal`)
gene.set.kras.aale.sc <- add.gene.set.to.sc(msig.h.kras.signal.up, `kras.isg.signature`)
gene.set.kras.aale.sc <- add.gene.set.to.sc(msig.h.emt, `msig.h.emt`)
gene.set.kras.aale.sc <- add.gene.set.to.sc(aale.up, `aale.up`)
gene.set.kras.aale.sc <- add.gene.set.to.sc(kras.gene.signature, `kras.gene.signature`)
# gene.set.kras.aale.sc <- add.gene.set.to.sc(kras.gene.signature, `kras.gene.signature`)
# gene.set.kras.aale.sc <- add.gene.set.to.sc(rig.i.mda5.induction, `rig.i.mda5.induction`)
# gene.set.kras.aale.sc <- add.gene.set.to.sc(alu.gene.set, `alu`)
# gene.set.kras.aale.sc <- add.gene.set.to.sc(mer.gene.set, `mer`)
# gene.set.kras.aale.sc <- add.gene.set.to.sc(line.gene.set, `line`)
# gene.set.kras.aale.sc <- add.gene.set.to.sc(ltr.gene.set, `ltr`)

gene.set.list <- lst(msig.df.h.ifna, kras.signal.up)

FeaturePlot(gene.set.kras.aale.sc, features = kras.signal.up)


gene.set.plot <- as.data.frame(as.matrix(gene.set.kras.aale.sc@meta.data)) %>% rownames_to_column('barcode') %>% 
  mutate(msig.df.h.ifna = as.double(msig.df.h.ifna),
         kras.signal.up = as.double(kras.signal.up),
         kras.isg.signature = as.double(kras.isg.signature),
         msig.h.emt = as.double(msig.h.emt),
         percent.KRAS = as.double(percent.KRAS),
         mapk.signal = as.double(mapk.signal),
         aale.up = as.double(aale.up),
         kras.gene.signature = as.double(kras.gene.signature))

aale_sc[["umap"]]@cell.embeddings %>% 
  as.data.frame() %>% rownames_to_column('barcode') %>%
  merge(gene.set.plot, by = 'barcode') %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = msig.df.h.ifna)) + 
  geom_point(alpha = 1) + 
  scale_color_gradient(low = 'grey', high = 'purple')

gene.set.plot %>% 
  merge(tmp.counts, by = 'barcode') %>% 
  ggplot(aes(KRAS, kras.isg.signature, color = orig.ident)) + 
  geom_point() + 
  geom_smooth(method = 'lm')
# spread data into gene columns
norm.counts.plot <- 
  aale_sc_norm_counts_tidy %>% 
  filter(gene %in% kras.gene.signature) %>% 
  merge(aale_sc_barcode_counts, by = 'barcode') %>% 
  group_by(barcode, orig.ident, seurat_clusters)

norm.counts.plot %>% 
  filter(gene %in% c('KRAS', 'ISG15')) %>% 
  ggplot(aes(gene, norm.counts, color = seurat_clusters)) + 
  geom_jitter(alpha = 0.4, position = position_dodge(width = 1)) +
  geom_boxplot(fill = NA, outlier.colour = NA, position = position_dodge(width = 1)) + 
  facet_row(~orig.ident)


aale_sc_norm_counts_tidy %>% 
  filter(gene %in% kras.gene.signature) %>% 
  spread(gene, norm.counts) -> tmp.counts


gene.set.plot %>% 
  ggplot(aes(seurat_clusters, mapk.signal, color = orig.ident)) + 
  geom_sina(alpha = 0.4, position = position_dodge(width = 1)) + 
  geom_boxplot(fill = NA, outlier.colour = NA, position = position_dodge(width = 1))

norm.counts.plot
  ggplot(aes(seurat_clusters, fill = orig.ident)) + 
  geom_bar(position = 'dodge') 
  
  
gene.set.plot %>% 
  dplyr::select(barcode, orig.ident, seurat_clusters) %>% 
  group_by(orig.ident, seurat_clusters) %>% 
  tally() %>% 
  summarize(percent = n/sum(n))

norm.counts.plot %>% 
  group_by(orig.ident, seurat_clusters) %>% 
  tally() %>% 
  group_by(orig.ident) %>% 
  mutate(total = sum(n)) %>% 
  ungroup() %>% 
  mutate(frac = n/total * 100) %>% 
  dplyr::select(orig.ident, seurat_clusters, frac) %>% 
  spread(seurat_clusters, frac)
  ggplot(aes(orig.ident, frac, fill = seurat_clusters)) + 
  geom_col(position = 'stack', color = 'white')

norm.counts.plot <- 
  kras.aale.sc.norm.counts %>% 
  group_by(barcode) %>% 
  subset(gene %in% unlist(eval(gene.set.list))) %>%
  spread(gene, norm.counts)

norm.counts.plot %>% 
  gather(gene, count, -cluster, -barcode) %>% 
  group_by(gene) %>% 
  summarise(count = mean(count)) %>% 
  filter(! gene %in% aale.de.seq$gene) %>% 
  top_n(20, count)

norm.counts.plot %>% 
  gather(gene, count, -cluster, -barcode) %>% 
  group_by(gene) %>% 
  summarise(count = mean(count)) %>% 
  # filter(! gene %in% aale.de.seq$gene) %>% 
  top_n(20, count)

# iterate through named list and create a column for each, populating with the avg counts of that set
for(name in names(gene.set.list)){
  norm.counts.plot[, name] <-
  rowMeans(norm.counts.plot[, colnames(norm.counts.plot) %>% 
                            subset(. %in% unlist(eval(gene.set.list[name])))])
}

# make a slimmer df to work with going forward
norm.counts.plot.final <-
  norm.counts.plot %>%
  dplyr::select(barcode, cluster, unlist(names(gene.set.list)))
```

### bisque
```{r}
library(BisqueRNA)
library(Biobase)

sc.eset <- BisqueRNA::SeuratToExpressionSet(aale_sc, delimiter = '_', position = 2, version = 'v3')

expand_grid(kras = colnames(salmon.quant$aale$deseq$counts)[grep("kras", colnames(salmon.quant$aale$deseq$counts))],
            ctrl = colnames(salmon.quant$aale$deseq$counts)[grep("ctrl", colnames(salmon.quant$aale$deseq$counts))]
            ) -> bulk.eset.grid

bulk.eset.grid %>% 
  pmap_df(function(kras, ctrl){
  
  print(kras)
  print(ctrl)
  
  assay(salmon.quant$aale$gxi, 'counts') %>% 
    as.data.frame() %>% 
    rownames_to_column('ensg') %>% 
    merge(gencode.35.tx.to.gene %>% dplyr::select(ensg, gene) %>% unique(), by = 'ensg') %>% 
    dplyr::select(gene, contains('.')) %>% 
    unique() %>% 
    group_by(gene) %>% add_tally() %>% filter(n == 1) %>% dplyr::select(-n) %>% 
    dplyr::select(gene, 'ctrl' = all_of(ctrl), 'kras' = all_of(kras)) %>% 
    remove_rownames() %>% column_to_rownames('gene') %>% 
    as.matrix() %>% Biobase::ExpressionSet(assayData = .) -> bulk.eset
  
  res <- BisqueRNA::ReferenceBasedDecomposition(bulk.eset, sc.eset, markers = NULL, use.overlap = F)
  
  return(res$bulk.props %>% as.data.frame() %>% rename(ctrl = 'ctrl', kras = 'kras') %>% rownames_to_column('cluster'))
  
}) -> bisque.rep.df


DimPlot(aale_sc, reduction = "umap", group.by = 'orig.ident') /
DimPlot(aale_sc, reduction = "umap", label = T) 

bisque.rep.df %>% 
  gather(condition, prop, -cluster) %>% 
  ggplot(aes(cluster, prop, color = condition)) + 
  geom_jitter(position = position_dodge(width = 1)) + 
  geom_boxplot(position = position_dodge(width = 1), fill = NA, outlier.color = NA)

bisque.rep.df %>% 
  gather(condition, frac, -cluster) %>% 
  group_by(cluster, condition) %>%
  summarize(mean = mean(frac)*100) %>% 
  spread(cluster, mean)

aale_sc_barcode_counts %>% 
  ggplot(aes(seurat_clusters, fill = orig.ident)) + 
  geom_bar() + 
  scale_fill_viridis_d()

```

### RNA velocity
```{r}
tximeta::loadLinkedTxome(file.path(reference.dir, "gencode.v35.annotation.expanded_docker.json"))

kras_txi <- tximeta(coldata = data.frame(
  names = 'aale_kras',
  files = file.path(output.data.dir, 
                         'alevin_kras.fastq_sel.align.gencode.v35.process.aware.salmon.v1.3.0.sidx',
                         'alevin/quants_mat.gz'),
  stringsAsFactors = F), type = 'alevin')

colnames(kras_txi) <- paste0('aale_kras_', colnames(kras_txi))

ctrl_txi <- tximeta(coldata = data.frame(
  names = 'aale_ctrl',
  files = file.path(output.data.dir, 
                         'alevin_ctrl.fastq_sel.align.gencode.v35.process.aware.salmon.v1.3.0.sidx',
                         'alevin/quants_mat.gz'),
  stringsAsFactors = F), type = 'alevin')

d14_txi <- tximeta(coldata = data.frame(
  names = 'aale_ctrl',
  files = file.path(output.data.dir, 
                         'alevin_aale.day14_sel.align.gencode.v35.process.aware.salmon.v1.3.0.sidx',
                         'alevin/quants_mat.gz'),
  stringsAsFactors = F), type = 'alevin')

colnames(d14_txi) <- paste0('aale_d14_', colnames(d14_txi))


aale_txi <- cbind(kras_txi, ctrl_txi)
aale_txi <- d14_txi

cg <- read.delim(file.path(reference.dir, "gencode.v35.annotation.expanded.tsv"),
                 header = TRUE, as.is = TRUE)
## Rename the 'intron' column 'unspliced' to make assay names compatible with scVelo
colnames(cg)[colnames(cg) == "intron"] <- "unspliced"

# kras_txi <- tximeta::splitSE(se = kras_txi, splitDf = cg, assayName = "counts")
# ctrl_txi <- tximeta::splitSE(ctrl_txi, cg, assayName = "counts")
aale_txi <- tximeta::splitSE(aale_txi, cg, assayName = "counts")

# kras_txi <- as(kras_txi, "SingleCellExperiment")
# assays(kras_txi) <- list(
#     counts = assay(kras_txi, "spliced"),
#     spliced = assay(kras_txi, "spliced"),
#     unspliced = assay(kras_txi, "unspliced")
# )

aale_txi_splice <- as(aale_txi, "SingleCellExperiment")
assays(aale_txi_splice) <- list(
    counts = assay(aale_txi_splice, "spliced"),
    spliced = assay(aale_txi_splice, "spliced"),
    unspliced = assay(aale_txi_splice, "unspliced")
)

aale_txi_list <- list('spliced' = assay(aale_txi_splice, 'spliced'), 
                      'counts' = assay(aale_txi_splice, 'spliced'),
                      'unspliced' = assay(aale_txi_splice, 'unspliced'))

aale_txi_seurat <- as.Seurat(x = aale_txi_list)
aale_txi_seurat@meta.data <- 
  aale_txi_seurat@meta.data %>% rownames_to_column('barcode') %>% 
  mutate(orig.ident = ifelse(grepl('kras', barcode), 'kras', 'ctrl')) %>% 
  column_to_rownames('barcode')

aale_txi_seurat[["RNA"]] <- aale_txi_seurat[["spliced"]]

# aale_txi_seurat <- SCTransform(aale_txi_seurat)

# aale_txi_seurat[["percent.mt"]] <- PercentageFeatureSet(aale_txi_seurat, pattern = "^MT-")

# aale_txi_seurat[["percent.KRAS"]] <- PercentageFeatureSet(aale_txi_seurat, pattern = "KRAS", assay = 'RNA')

VlnPlot(aale_txi_seurat, features = c("nCount_spliced", "nCount_unspliced"), ncol = 4)
aale_txi_seurat <- subset(aale_txi_seurat, subset = nCount_spliced > 2000 )
VlnPlot(aale_txi_seurat, features = c("nCount_spliced", "nCount_unspliced"), ncol = 3)
aale_txi_seurat <- NormalizeData(aale_txi_seurat)

set.seed(123)
aale_txi_seurat <- FindVariableFeatures(aale_txi_seurat, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(aale_txi_seurat), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(aale_txi_seurat)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot2

all.genes <- rownames(aale_txi_seurat)
aale_txi_seurat <- ScaleData(aale_txi_seurat, features = all.genes)

aale_txi_seurat <- RunPCA(aale_txi_seurat)
aale_txi_seurat <- FindNeighbors(aale_txi_seurat, dims = 1:20)
aale_txi_seurat <- FindClusters(aale_txi_seurat)
aale_txi_seurat <- RunUMAP(aale_txi_seurat, dims = 1:20)
aale_txi_seurat <- SeuratWrappers::RunVelocity(object = aale_txi_seurat, deltaT = 1, kCells = 25, fit.quantile = 0.02)

ident.colors <- (scales::hue_pal())(n = length(x = levels(x = aale_txi_seurat)))
names(x = ident.colors) <- levels(x = aale_txi_seurat)
cell.colors <- ident.colors[Idents(object = aale_txi_seurat)]
names(x = cell.colors) <- colnames(x = aale_txi_seurat)

FeaturePlot(aale_txi_seurat, features = c('ENSG00000173432.12', 'ENSG00000125538.12')) + theme_set_fun()
DimPlot(aale_txi_seurat, reduction = "umap", group.by = 'orig.ident') 

aale_txi_seurat@meta.data
velocyto.R::show.velocity.on.embedding.cor(emb = Embeddings(object = aale_txi_seurat, reduction = "umap"), 
                               vel = aale_txi_seurat@tools$`SeuratWrappers::RunVelocity`, 
                               n = 200, scale = "sqrt", cell.colors = cell.colors,
                               cex = 0.8, arrow.scale = 3, show.grid.flow = TRUE, min.grid.cell.mass = 0.5, 
                               grid.n = 40, arrow.lwd = 1, do.par = FALSE, cell.border.alpha = 0.1)



DefaultAssay(aale_txi_seurat) <- "RNA"
SeuratDisk::SaveH5Seurat(aale_txi_seurat, filename = file.path(output.data.dir, 'aale_splice_seurat.h5Seurat'))
SeuratDisk::Convert(file.path(output.data.dir, 'aale_splice_seurat.h5Seurat'), dest = "h5ad")

```
###
```{r}
kras_splice_alevin_sc <- 
  Seurat::CreateSeuratObject(counts = kras_txi$counts, min.cells = 3, min.features = 200, project = 'kras')
ctrl_splice_alevin_sc <- 
  Seurat::CreateSeuratObject(counts = ctrl_txi$counts, min.cells = 3, min.features = 200, project = 'ctrl')
```
###
```{r}
aale_sc <- merge(kras_alevin_sc, ctrl_alevin_sc, add.cell.ids=c('aale_kras', 'aale_ctrl'))
```




# Figures

## Fig 1.

### A: Biotype distribution 
```{r}
biotype.dist <- function(tx.counts){
  return(tx.counts %>% 
    rownames_to_column('enst') %>% 
    merge(gencode.35.tx.to.gene, by = 'enst') %>% 
    gather(sample, count, -enst, -ensg:-biotype) %>% 
    mutate(sample.parse = sample) %>% 
    separate(sample.parse, sep = '[.]', 
           into = c('platform', 'context', 'rep', 'condition')) %>% 
    mutate(biotype = ifelse(biotype %in% c('lncRNA', 'Mt_rRNA', 'protein_coding', 'retained_intron',
                                           'Alu', 'L1', 'ERV1'),
                        biotype, 'other'),
           biotype = factor(biotype, levels = c('protein_coding', 'retained_intron', 'Mt_rRNA', 'lncRNA', 'other'))) %>%
    group_by(biotype, sample, condition) %>% 
    summarise(count = sum(count)) %>% 
    group_by(sample) %>% 
    mutate(freq = count / sum(count)))
}

tot.biotype.dist <- function(tx.counts){
  return(tx.counts %>% 
    rownames_to_column('enst') %>% 
    merge(total.tx.to.gene, by = 'enst') %>% 
    gather(sample, count, -enst, -ensg:-biotype) %>% 
    mutate(sample.parse = sample) %>% 
    separate(sample.parse, sep = '[.]', 
           into = c('platform', 'context', 'rep', 'condition')) %>% 
    mutate(biotype = ifelse(biotype %in% c('lncRNA', 'Mt_rRNA', 'protein_coding', 'retained_intron',
                                           'Alu', 'L1', 'ERV1'),
                            biotype, 'other'),
           biotype = factor(biotype, levels = c('protein_coding', 'retained_intron', 'Mt_rRNA', 'lncRNA', 'other',
                            'Alu', 'L1', 'ERV1'))) %>% 
    group_by(biotype, sample, condition) %>% 
    summarise(count = sum(count)) %>% 
    group_by(sample) %>% 
    mutate(freq = count / sum(count)))
}


biotype.dist.plt <- function(tx.biotype.dist){
  tx.biotype.dist %>% 
    merge(metadata.df, by.x = 'sample', by.y = 'names') %>% 
    distinct() %>% 
    unite(condition, c(condition.x, context)) %>% 
    mutate(condition = factor(condition, levels = c('DMSO_2D', 'AMG_2D', 'DMSO_3D', 'AMG_3D')),
           tmp = sample) %>% 
    separate(tmp, sep='[.]', into = c(NA, NA, 'rep', NA)) %>% 
    ggplot(aes(rep, freq, fill = biotype, color = biotype)) +
      geom_bar(stat = 'identity', color = 'white') +
      scale_fill_viridis_d( direction = 1) +
      scale_x_discrete(expand = c(0, 0.5)) +
      xlab('') + ylab('% of total counts') +
    facet_row(~condition, scales = 'free_x')
}

```
####
```{r}

salmon.quant$rnaEasy_all$deseq$biotype.dist <- biotype.dist(salmon.quant$rnaEasy_all$deseq$txi.counts)

biotype.dist.plt(salmon.quant$rnaEasy_all$deseq$biotype.dist)

panel.save(figure = 1, name = 'rnaEasy_gencode_biotype_dist', width = 'medium', height = 'single')
##
salmon.quant$exoTIC_2D$deseq$biotype.dist <- biotype.dist(salmon.quant$exoTIC_2D$deseq$txi.counts)

biotype.dist.plt(salmon.quant$exoTIC_2D$deseq$biotype.dist)

panel.save(figure = 1, name = 'exoTIC_2D_gencode_biotype_dist', width = 'single', height = 'single')
##
salmon.quant$exoTIC_3D$deseq$biotype.dist <- biotype.dist(salmon.quant$exoTIC_3D$deseq$txi.counts)

biotype.dist.plt(salmon.quant$exoTIC_3D$deseq$biotype.dist)

panel.save(figure = 1, name = 'exoTIC_3D_gencode_biotype_dist', width = 'single', height = 'single')
##
ucsc.rmsk.salmon.quant$rnaEasy_all$deseq$biotype.dist <-
  tot.biotype.dist(ucsc.rmsk.salmon.quant$rnaEasy_all$deseq$txi.counts)

biotype.dist.plt(ucsc.rmsk.salmon.quant$rnaEasy_all$deseq$biotype.dist)

panel.save(figure = 1, name = 'rnaEasy_gencode_biotype_dist', width = 'medium', height = 'single')
##
ucsc.rmsk.salmon.quant$exoTIC_2D$deseq$biotype.dist <-
  tot.biotype.dist(ucsc.rmsk.salmon.quant$exoTIC_2D$deseq$txi.counts)

biotype.dist.plt(ucsc.rmsk.salmon.quant$exoTIC_2D$deseq$biotype.dist)

panel.save(figure = 1, name = 'exoTIC_2D_gencode_biotype_dist', width = 'single', height = 'single')
##
merge(salmon.quant$rnaEasy_all$deseq$biotype.dist, 
      ucsc.rmsk.salmon.quant$rnaEasy_all$deseq$biotype.dist, by = c('biotype', 'sample')) %>% 
  dplyr::select(biotype, sample, condition = condition.x, gencode_freq = freq.x, total_freq = freq.y) %>% 
  # filter_at(vars(contains('_freq')), all_vars(. >= 0.01)) %>% 
  filter(biotype %in% c('protein_coding', 'Mt_rRNA', 'lncRNA', 'processed_transcript', 'nonsene_mediated_decay', 'retained_intron')) %>% 
  mutate(freq_diff = total_freq - gencode_freq) %>% 
  ggplot(aes(reorder(biotype, freq_diff), freq_diff, color = condition)) + 
  scale_color_manual(values = c(viridis(1)[[1]], viridis(3)[[2]], viridis(5)[[5]])) +
  geom_boxplot(position = position_dodge(width = 1)) + 
  geom_sina(position = position_dodge(width = 1))


```

### A: Volcano
```{r}
gencode.de.volcano <- function(de.seq){
  de.seq <- 
    de.seq %>% filter(!grepl('^MT', gene)) %>% 
    mutate(biotype = ifelse(gene %in% gencode.35.lnc.gene.names$gene, 'lncRNA','coding'),
           padj = ifelse(padj == 0, min(filter(de.seq, padj != 0)$padj), padj))
  x.max <- round(max(abs(de.seq$log2FoldChange)) + 0.5)
  print(x.max)
  label.max <- 0.01
  ggplot(de.seq, 
         aes(log2FoldChange, -log10(padj), 
             color = biotype)) +
      geom_point(alpha = 0.75, size = rel(2)) + 
      geom_rug(size = rel(1), alpha = 0.15) + 
      scale_x_continuous(limits = c(-x.max,x.max), expand = c(0,0.5),
                         breaks = c(-x.max, -x.max/2, -1, 0, 1, x.max/2, x.max)) +
      scale_color_manual(values = c(viridis(1)[[1]], viridis(3)[[2]], viridis(5)[[5]])) +
      xlab('log2(Fold Change)') +
      ylab('-log10(p.adj)') + 
      geom_vline(xintercept = 0, linetype = 'dashed', alpha = 0.4) #+
      # geom_text_repel(aes(label = ifelse(padj <= label.max & log2FoldChange <= -x.max/1.5| log2FoldChange >= x.max/1.5,
      #                                    as.character(gene), '')),
      # # geom_text_repel(aes(label = as.character(gene)),
      #                         box.padding = unit('1', 'lines'),
      #                         segment.color = 'grey',
      #                         segment.alpha = 0.2,
      #                         color = 'black',
      #                         ylim = c(1, Inf), size = base_size/2, family = 'Helvetica')
}

fgsea.hallmark.de.volcano <- function(fgsea){
  fgsea <- 
    fgsea %>% filter(grepl('HALLMARK|SWEET', pathway))
  x.max <- round(max(abs(fgsea$NES)) + 0.5)
  ggplot(fgsea, 
         aes(NES, -log10(padj), 
             color = size, 
             label = tolower(sub('HALLMARK', '', pathway)))) +
      geom_point(alpha = 0.6) + 
      geom_rug(size = rel(1), alpha = 0.6) + 
      scale_size_continuous(name = 'genes') +
      scale_x_continuous(limits = c(-x.max,x.max), expand = c(0,0.5),
                         breaks = c(-x.max, -x.max/2, -1, 0, 1, x.max/2, x.max)) +
      scale_color_viridis_c() +
      xlab('NES') +
      ylab('-log10(p.adj)') + 
      geom_text_repel(box.padding = unit('0.8', 'lines'),
                              segment.color = 'grey',
                              segment.alpha = 0.2,
                              color = 'black',
                              ylim = c(2.0, Inf), size = rel(1.5))
}
```
####
```{r}

gencode.de.volcano(salmon.quant$aale$deseq$de %>% 
                     filter(gene %in% msig.df$HALLMARK_INTERFERON_GAMMA_RESPONSE)) -> aale_ifn_de.fig
panel.save(figure = 'hbec', name = 'aale_ifn_de', width = 'single', height = 'single', aale_ifn_de.fig)
##
gencode.de.volcano(salmon.quant$exoTIC_3D$deseq$de) + theme(legend.position = c(0.95, 0.95))
panel.save(figure = 2, name = 'exoTIC_3D_gencode_volcano', width = 'single', height = 'single')
##
gencode.de.volcano(salmon.quant$rnaEasy_2D$deseq$de) + theme(legend.position = c(0.35, 0.95))
panel.save(figure = 1, name = 'rrnaEasy_2D_gencode_volcano', width = 'single', height = 'single')
##
gencode.de.volcano(salmon.quant$rnaEasy_3D$deseq$de) + theme(legend.position = c(0.35, 0.95))
panel.save(figure = 1, name = 'rrnaEasy_3D_gencode_volcano', width = 'single', height = 'single')
##
gencode.de.volcano(kras_wt.vs.g12c_de) + theme(legend.position = c(0.35, 0.95))
panel.save(figure = 1, name = 'kras_wt.vs.g12c_volcano', width = 'single', height = 'single')
```

## FUN: de.scatter
```{r}
de.scatter <- function(x.axis, y.axis, x.name, y.name){
  
  x.axis %>% filter(padj < 0.05) %>% 
    merge(y.axis %>% filter(padj < 0.05), by = 'gene') %>% 
    # mutate(biotype = ifelse(gene %in% gencode.35.lnc.gene.names$gene, 'lncRNA','coding')) %>% 
    filter(!grepl('^RPS|^MT', gene)) %>% 
    # ggplot(aes(log2FoldChange.x, log2FoldChange.y, color = ifelse(abs(log2FoldChange.x) > 1 & abs(log2FoldChange.y) > 1,
    #                                                               biotype, '<1'))) + 
    ggplot(aes(log2FoldChange.x, log2FoldChange.y)) +
      geom_line(stat = 'smooth', method = 'lm', formula = y~x, alpha = 0.5, color = 'red', linetype = 'dashed') +
      geom_point() +
      xlab(x.name) + ylab(y.name) + 
      geom_hline(yintercept = 0, linetype = 'dashed', alpha=0.2) + 
      geom_hline(yintercept = c(-1,1), linetype = 'dashed', alpha=0.1) + 
      geom_vline(xintercept = 0, linetype = 'dashed', alpha=0.2) +
      geom_vline(xintercept = c(-1,1), linetype = 'dashed', alpha=0.1) + 
      scale_color_manual(values = c( 'grey', viridis(1)[[1]], viridis(3)[[2]]), name = 'biotype') +
      geom_text_repel(aes(label = ifelse(abs(log2FoldChange.x) >= 1 & abs(log2FoldChange.y) >= 1, gene, '')),
                      show.legend = F)

}
```
### 
```{r}
de.scatter(x.axis = salmon.quant$aale$deseq$de %>% filter(gene %in% msig.df$HALLMARK_INTERFERON_GAMMA_RESPONSE), 
           y.axis = salmon.quant$hbec_v12$deseq$de,
           x.name = 'aale', y.name = 'WT_v_mut2') -> aale_v_wtVlacz.fig
panel.save(figure = 'hbec', 
           name = 'aale_mut2_v_WT_ifng_scatter', width = 'single', height = 'double', aale_v_wtVlacz.fig)
##
de.scatter(x.axis = ucsc.rmsk.salmon.quant$aale$intra$deseq$de, 
           y.axis = ucsc.rmsk.salmon.quant$aale$exo$deseq$de,
           x.name = 'intra', y.name = 'exo') 

ggsave(filename = file.path(figure.dir, 'nci_R41_scatter.pdf'), width = 3.46, height = 4.3/2, units = 'in', device = 'pdf')


ucsc.rmsk.salmon.quant$aale$intra$deseq$de %>% filter(padj < 0.05) %>% 
  merge(ucsc.rmsk.salmon.quant$aale$exo$deseq$de %>% filter(padj < 0.05), by = 'gene') %>% 
  filter(!grepl('^RPS|^MT', gene)) %>% 
  lm(log2FoldChange.x ~ log2FoldChange.y, data = .) %>% 
  summary()


ggsave(filename = file.path(figure.dir, 'nci_R41_scatter.pdf'), width = 3.46, height = 4.3/2, units = 'in', device = 'pdf')
panel.save(figure = 'hbec', 
           name = 'aale_mut2_v_WT_ifng_scatter', width = 'single', height = 'double', aale_v_wtVlacz.fig)
##
de.scatter(x.axis = salmon.quant$exoTIC_2D$deseq$de, 
           y.axis = salmon.quant$rnaEasy_3D$deseq$de,
           x.name = 'exoTIC_2D', y.name = 'rnaEasy_3D') + theme(legend.position = c(0.95, 0.20))
panel.save(figure = 2, name = 'exoTIC_2DvrnaEasy_3D_gencode_scatter', width = 'single', height = 'double')
##
de.scatter(x.axis = salmon.quant$exoTIC_2D$deseq$de, 
           y.axis = kras_wt.vs.g12c_de,
           x.name = 'exoTIC_2D', y.name = 'luad_G12C') + theme(legend.position = c(0.95, 0.20))
panel.save(figure = 2, name = 'exoTIC_2Dvluad_G12C_gencode_scatter', width = 'single', height = 'double')
##
de.scatter(x.axis = salmon.quant$rnaEasy_2D$deseq$de, 
           y.axis = salmon.quant$rnaEasy_3D$deseq$de,
           x.name = 'rnaEasy_2D', y.name = 'rnaEasy_3D') + theme(legend.position = c(0.95, 0.20))
panel.save(figure = 1, name = 'rnaEasy_2Dv3D_gencode_scatter', width = 'single', height = 'double')
##
de.scatter(x.axis = salmon.quant$rnaEasy_2D$deseq$de, 
           y.axis = kras_wt.vs.g12c_de,
           x.name = 'rnaEasy_2D', y.name = 'luad_G12C') + theme(legend.position = c(0.95, 0.20))
panel.save(figure = 1, name = 'rnaEasy_2Dvluad_G12C_gencode_scatter', width = 'single', height = 'double')
##
de.scatter(x.axis = salmon.quant$rnaEasy_3D$deseq$de, 
           y.axis = kras_wt.vs.g12c_de,
           x.name = 'rnaEasy_3D', y.name = 'luad_G12C') + theme(legend.position = c(0.95, 0.20))
panel.save(figure = 1, name = 'rnaEasy_3Dvluad_G12C_gencode_scatter', width = 'single', height = 'double')
```

### GSEA Heatmaps
```{r}

salmon.quant$rnaEasy_2D$deseq$H.fgsea %>%
  # dplyr::select(pathway, padj, NES) %>% 
  # mutate(experiment = 'exoTIC_2D') %>% 
  # rbind(salmon.quant$rnaEasy_2D$deseq$H.fgsea %>% 
  dplyr::select(pathway, padj, NES) %>% 
  mutate(experiment = 'rnaEasy_2D') %>% 
  rbind(salmon.quant$rnaEasy_3D$deseq$H.fgsea %>% 
    dplyr::select(pathway, padj, NES) %>% 
    mutate(experiment = 'rnaEasy_3D')) %>% 
  filter(padj <= 0.05) %>% 
  mutate(padj = -log10(padj)) %>% 
  separate(pathway, sep = 'HALLMARK ', into = c(NA, 'pathway')) %>% 
  dplyr::select(-NES) %>% 
  spread(experiment, padj) %>%
  replace(is.na(.), 0) %>%
  column_to_rownames('pathway') %>%
  pheatmap(color = viridis(32, option = 'magma'), fontsize = 8, 
           treeheight_row = 2, treeheight_col = 2) -> h.fgsea.rnaEasy.heatmap

save_pheatmap_pdf(h.fgsea.rnaEasy.heatmap, filename = file.path(figure.dir, 'fig.1', 'h.fgsea.rnaEasy.heatmap.pdf'), 
                  width = panel.figure.width.in, height = panel.figure.height.in/3)

salmon.quant$rnaEasy_2D$deseq$H.fgsea %>%
  dplyr::select(pathway, padj, NES) %>% 
  mutate(experiment = 'rnaEasy_2D') %>% 
  rbind(salmon.quant$rnaEasy_3D$deseq$H.fgsea %>% 
    dplyr::select(pathway, padj, NES) %>% 
    mutate(experiment = 'rnaEasy_3D')) %>% 
  rbind(kras_wt.vs.g12c_de_h.fgsea %>% 
        dplyr::select(pathway, padj, NES) %>% 
        mutate(experiment = 'luad_G1C')) %>%
  filter(padj <= 0.05) %>% 
  mutate(padj = -log10(padj)) %>% 
  separate(pathway, sep = 'HALLMARK ', into = c(NA, 'pathway')) %>% 
  dplyr::select(-padj) %>% 
  spread(experiment, NES) %>%
  replace(is.na(.), 0) %>%
  column_to_rownames('pathway') %>%
  pheatmap(color = viridis(32, option = 'magma'), fontsize = 8, 
           treeheight_row = 2, treeheight_col = 2) -> h.fgsea.rnaEasy_v_luad.heatmap

save_pheatmap_pdf(h.fgsea.rnaEasy_v_luad.heatmap, filename = file.path(figure.dir, 'fig.1',
                                                                       'h.fgsea.rnaEasy_v_luad.heatmap.pdf'), 
                  width = panel.figure.width.in, height = panel.figure.height.in/2)



salmon.quant$hbec_v12$deseq$H.fgsea %>% 
  filter(padj <= 0.05) %>% 
  separate(pathway, sep = 'HALLMARK ', into = c(NA, 'pathway')) %>% 
  mutate(padj = -log10(padj)) %>% 
  ggplot(aes(padj, NES, label = pathway)) + 
  geom_point() + geom_segment(aes(x=0, xend=padj, y=0, yend=NES)) +
  geom_text_repel(point.padding = 1) -> aale.gsea.lolli.fig

panel.save(figure = 'hbec', name = 'mut2_v_WT', width = 'double', height = 'single', aale.gsea.lolli.fig)


salmon.quant$hbec_wt$deseq$H.fgsea %>% 
  filter(padj <= 0.05) %>% 
  separate(pathway, sep = 'HALLMARK ', into = c(NA, 'pathway')) %>% 
  mutate(padj = -log10(padj)) %>% 
  ggplot(aes(padj, NES, label = pathway)) + 
  geom_point() + geom_segment(aes(x=0, xend=padj, y=0, yend=NES)) +
  geom_text_repel(point.padding = 1)

salmon.quant$lacz_v_wt$deseq$H.fgsea %>% 
  filter(padj <= 0.05) %>% 
  separate(pathway, sep = 'HALLMARK ', into = c(NA, 'pathway')) %>% 
  mutate(padj = -log10(padj)) %>% 
  ggplot(aes(padj, NES, label = pathway)) + 
  geom_point() + geom_segment(aes(x=0, xend=padj, y=0, yend=NES)) +
  geom_text_repel(point.padding = 1)

salmon.quant$lacz_v_v12$deseq$H.fgsea %>% 
  filter(padj <= 0.05) %>% 
  separate(pathway, sep = 'HALLMARK ', into = c(NA, 'pathway')) %>% 
  mutate(padj = -log10(padj)) %>% 
  ggplot(aes(padj, NES, label = pathway)) + 
  geom_point() + geom_segment(aes(x=0, xend=padj, y=0, yend=NES)) +
  geom_text_repel(point.padding = 1)

salmon.quant$hbec_v12$deseq$H.fgsea %>% 
  filter(padj <= 0.05) %>% 
  separate(pathway, sep = 'HALLMARK ', into = c(NA, 'pathway')) %>% 
  mutate(padj = -log10(padj)) %>% 
  ggplot(aes(padj, NES, label = pathway)) + 
  geom_point() + geom_segment(aes(x=0, xend=padj, y=0, yend=NES)) +
  geom_text_repel(point.padding = 1)




panel.save(figure = 2, name = 'total_gsea_compare_bar', width = 'medium', height = 'single')

```

### D: Hclust
```{r}
gene.expression.hclust.plt <- function(gene.counts, row.true = T, col.true = T){
  gene.counts %>% 
    dplyr::select(-ensg, gene, contains('.')) %>% 
    filter_at(vars(contains('.')), any_vars(. >= 10)) %>%
    distinct() %>% 
    gather(sample, count, -gene) %>% 
    filter(!grepl('^MT', gene)) %>% 
    group_by(gene) %>%
    mutate(count = scale(log(count+1), center = T)) %>%
    dplyr::select(sample, gene, count) %>%
    pivot_wider(names_from = gene, values_from = count) %>%
    distinct() %>% 
    column_to_rownames('sample') %>% 
    t() %>% as.data.frame() %>% 
    pheatmap(show_rownames = row.true, show_colnames = col.true, 
             treeheight_row = 10, treeheight_col = 10,
             annotation_colors = anno_colors_2, annotation_col = anno_data_2) 
}


tx.expression.hclust.plt <- function(tx.counts){
  tx.counts %>% 
    filter_at(vars(contains('.')), all_vars(. >= 1)) %>% 
    gather(patient, count, -tx:-biotype) %>% 
    filter(!grepl('^MT', gene)) %>% 
    mutate(count = log(count),
           count = scale(count, center = T)) %>% 
    spread(patient, count) %>% 
    column_to_rownames('tx') %>% 
    dplyr::select(-gene, -len, -biotype) %>% 
    pheatmap(treeheight_row = 10, treeheight_col = 10,
             show_rownames = F, color = viridis(32), 
             border_color = NA)
}

```
####
```{r}

anno_colors <- list(condition = c('kras' = viridis(5)[[1]], 
                                  'ctrl' = viridis(5)[[2]], 
                                  'wt2_kras_v12' = viridis(5)[[3]],
                                  'wt2_kras_wt' = viridis(5)[[4]],
                                  'wt2_lacz' = viridis(5)[[5]]))

anno_colors_2 <- list(condition = c('kras' = viridis(6)[[1]], 
                                  'ctrl' = viridis(6)[[2]], 
                                  'wt2_kras_v12' = viridis(6)[[3]],
                                  'wt2_kras_wt' = viridis(6)[[4]],
                                  'wt2_lacz' = viridis(6)[[5]],
                                  'mut2_kras_v12' = viridis(6)[[6]]))

metadata.df %>% 
  filter(condition %in% names(anno_colors$condition)) %>% 
  dplyr::select(names, condition) %>% 
  column_to_rownames('names') -> anno_data

metadata.df %>% 
  filter(condition %in% names(anno_colors_2$condition)) %>% 
  dplyr::select(names, condition) %>% 
  column_to_rownames('names') -> anno_data_2

gene.expression.hclust.plt(salmon.quant$intra$deseq$counts %>% 
                             dplyr::select(gene, ensg, contains('aale'), contains('wt2')) %>% 
                             filter(gene %in% filter(salmon.quant$aale$deseq$de, abs(log2FoldChange) >= 1)$gene) %>%
                             filter(grepl('ZNF', gene)))

gene.expression.hclust.plt(salmon.quant$intra$deseq$counts %>% 
                             dplyr::select(gene, ensg, contains('aale'), contains('wt2'), contains('mut2_kras_v12')) %>%
                             # filter(gene %in% filter(salmon.quant$aale$deseq$de, padj <= 0.01)$gene) %>%
                             filter(gene %in% msig.df$HALLMARK_KRAS_G12D_ZNF_DN), 
                              row.true = T, 
                              col.true = F) -> kras_up_hclust.fig
                             # filter(gene %in% c('KRAS', 'TP53', 'MYC', 'BRAF', 
                             #                    'CXCL8', 'IL6', 'ISG15', 'DDX58', 
                             #                    'ZNF736', 'ZNF354C', 'ZNF793-AS1')))

save_pheatmap_pdf(kras_up_hclust.fig, width = panel.figure.width.in*1.5, height = panel.figure.height.in/2,
                  filename = file.path(figure.dir, 'fig.hbec', 'ifng_up_hclust.pdf'))


salmon.quant$rnaEasy_all$deseq$counts %>% 
  dplyr::select(-ensg, gene, contains('.')) %>% 
  filter(gene %in% g12c.marker.genes$induced) %>% 
  gather(sample, count, -gene) %>% 
  mutate(count = log(count + 1),
         count = scale(count, center = T)) %>% 
  pivot_wider(names_from = sample, values_from = count, values_fn = mean) %>% 
  column_to_rownames('gene') %>%
  pheatmap(treeheight_row = 10, treeheight_col = 10, show_rownames = F)


salmon.quant$rnaEasy_all$deseq$counts %>% 
  # separate(gene, sep = '_', into = c('gene', 'ensg')) %>% 
  filter(gene %in% g12c.marker.genes$induced) %>%
  unite(col = 'gene', sep = '_', c('gene', 'ensg')) %>%
  filter_at(vars(contains('.')), any_vars(. >= 1)) %>%
  column_to_rownames('gene') %>% 
  as.matrix() %>% cor(method = 'pearson') %>% pheatmap(color = viridis(32, option = 'magma'))


salmon.quant$deseq$counts %>% 
  # separate(gene, sep = '_', into = c('gene', 'ensg')) %>% 
  # filter(gene %in% gencode.35.lnc.gene.names$gene) %>%
  unite(col = 'gene', sep = '_', c('gene', 'ensg')) %>%
  filter_at(vars(contains('.')), any_vars(. >= 1)) %>%
  column_to_rownames('gene') %>% 
  as.matrix() %>% cor() -> norm.mtx

norm.mtx[1,2] - batch.mtx[1,2] 

norm.mtx - batch.mtx -> diff.mtx

norm.mtx %>% pheatmap(color = viridis(32, option = 'magma'))


salmon.quant$deseq$counts %>% 
    rownames_to_column('gene') %>% 
    filter(grepl('RAS', gene))

```


### E: TE volcano
```{r}
te.de.volcano <- function(de.seq){
  de.seq <- 
    de.seq %>% 
    filter(!grepl('^MT', gene)) %>% 
    merge(te.families.clades, by = 'gene', all.x = T) %>% 
    mutate(clade = ifelse(gene %in% gencode.35.lnc.gene.names$gene, 'lncRNA', clade),
           family = ifelse(is.na(family), 'gencode', family),
           clade = ifelse(is.na(clade), 'gencode', clade))
  
  x.max <- round(max(abs(de.seq$log2FoldChange)))
  label.max <- 0.01
  print(head(de.seq %>% filter(clade %in% c('SINE', 'LTR', 'DNA', 'LINE'))))
  
  ggplot(de.seq %>% 
           filter(clade %in% c('SINE', 'LTR', 'DNA', 'LINE')), 
         aes(log2FoldChange, -log10(padj), color = clade)) +
      geom_point(alpha = 0.8, size = rel(1)) + 
      geom_rug(size = rel(1), alpha = 0.4) + 
      # scale_x_continuous(limits = c(-x.max,x.max), expand = c(0,0.5),
      #                    breaks = c(-x.max/2, 0, x.max/2)) +
      scale_color_viridis_d(direction = -1) +
      xlab('log2(Fold Change)') +
      ylab('-log10(p.adj)') + 
      geom_vline(xintercept = 0, linetype = 'dashed', alpha = 0.4) +
      geom_text_repel(aes(label = ifelse(padj < label.max & log2FoldChange <= -x.max/0.5| log2FoldChange >= x.max/0.5,
                                         as.character(gene), '')),
                              box.padding = unit('0.8', 'lines'),
                              segment.color = 'grey',
                              segment.alpha = 0.2,
                              color = 'black',
                              ylim = c(2, Inf), size = rel(2))
    
}
```
####
```{r}

te.de.volcano(ucsc.rmsk.salmon.quant$lacz_v_wt$deseq$de) -> lacz_v_WT_te_de
panel.save(figure = 'hbec', 
           name = 'lacz_v_WT_te_de', width = 'single', height = 'double', lacz_v_WT_te_de)
te.de.volcano(ucsc.rmsk.salmon.quant$lacz_v_v12$deseq$de) -> lacz_v_WT_te_de
panel.save(figure = 'hbec', 
           name = 'lacz_v_V12_te_de', width = 'single', height = 'double', lacz_v_WT_te_de)
te.de.volcano(ucsc.rmsk.salmon.quant$hbec_v12$deseq$de) -> lacz_v_WT_te_de
panel.save(figure = 'hbec', 
           name = 'mut2_v_WT_te_de', width = 'single', height = 'double', lacz_v_WT_te_de)
te.de.volcano(ucsc.rmsk.salmon.quant$hbec_wt$deseq$de) -> lacz_v_WT_te_de
panel.save(figure = 'hbec', 
           name = 'V12_v_WT_te_de', width = 'single', height = 'double', lacz_v_WT_te_de)


te.de.volcano(ucsc.rmsk.salmon.quant$aale$exo$deseq$de) + xlim(-2,2)

te.de.volcano(ucsc.rmsk.salmon.quant$aale$compare$deseq$de) + theme(legend.position = c(0.98, 0.95))
ggsave(filename = file.path(figure.dir, 'nci_R41_compare_de.pdf'), width = 3.46, height = 4.3/2, units = 'in', device = 'pdf')



ucsc.rmsk.salmon.quant$rnaEasy_3D$deseq$de %>% 
  merge(ucsc.rmsk.salmon.quant$exoTIC_2D$deseq$de, by = 'gene', all = T) %>% 
    filter(!grepl('^MT', gene)) %>% 
  merge(te.families.clades, by = 'gene', all.x = T) %>% 
  mutate(clade = ifelse(gene %in% gencode.35.lnc.gene.names$gene, 'lncRNA', clade),
         family = ifelse(is.na(family), 'gencode', family),
         clade = ifelse(is.na(clade), 'gencode', clade)) %>% 
  filter(clade %in% c('SINE', 'LTR', 'DNA', 'LINE')) %>% 
  ggplot(aes(log2FoldChange.x, log2FoldChange.y, color = clade)) + 
  geom_point() +
  xlab('rnaEasy_3D') + ylab('exoTIC_2D') +
  scale_color_viridis_d(direction = -1) +
  geom_vline(xintercept = 0, linetype = 'dashed', alpha = 0.4) +
  geom_hline(yintercept = 0, linetype = 'dashed', alpha = 0.4) +
  facet_wrap(~clade, nrow = 2, ncol = 2, shrink = T)

ucsc.rmsk.salmon.quant$panc_v_ctrl$deseq$de %>% mutate(log2FoldChange = -log2FoldChange) %>% 
  merge(ucsc.rmsk.salmon.quant$kraskd_v_kras$deseq$de %>% mutate(log2FoldChange = -log2FoldChange), by = 'gene', all = T) %>% 
    filter(!grepl('^MT', gene)) %>% 
  merge(te.families.clades, by = 'gene', all.x = T) %>% 
  mutate(clade = ifelse(gene %in% gencode.35.lnc.gene.names$gene, 'lncRNA', clade),
         family = ifelse(is.na(family), 'gencode', family),
         clade = ifelse(is.na(clade), 'gencode', clade)) %>% 
  filter(clade %in% c('SINE', 'LTR', 'DNA', 'LINE')) %>% 
  ggplot(aes(log2FoldChange.x, log2FoldChange.y, color = clade)) + 
  geom_point() +
  # geom_text_repel(aes(label = ifelse(abs(log2FoldChange.x) > 1 & abs(-log2FoldChange.y) > 1, gene, ''))) + 
  geom_text_repel(aes(label = gene)) +
  scale_color_viridis_d(direction = -1) +
  geom_hline(yintercept = 0) + geom_vline(xintercept = 0) +
  facet_wrap(~clade, nrow = 2, ncol = 2, shrink = T)
    

```

### F: RNA editing
```{r}
rna.editing.summary <- read_csv(paste0(output.data.dir, 
                                       'rna.editing.out/alu.total.bed/summary_dir/EditingIndex.csv')) %>% 
  filter(StrandDecidingMethod == 'RefSeqThenMMSites') %>%
  #separate(Sample, sep = '[.]', into = c('condition', 'rep')) %>% 
  dplyr::select(Sample, noise = 'A2CEditingIndex',  signal = 'A2GEditingIndex') %>% 
  filter(!grepl('intra|exo', Sample)) %>% 
  mutate(condition = ifelse(grepl('panc', Sample), 'panc', 'ctrl'),
         Sample = sub('.sorted', '', Sample)) %>% 
  filter(Sample %in% tx.patient.biotype.sample.detection.count$sample)

rna.editing.summary <- read_csv(paste0(output.data.dir, 
                                       'rna.editing.out/alu.total.bed/summary_dir/EditingIndex.csv')) %>% 
  filter(StrandDecidingMethod == 'RefSeqThenMMSites') %>%
  filter(grepl('intra|exo', Sample)) %>% 
  separate(Sample, sep = '[.]', into = c('condition', 'rep', 'context', NA)) %>% 
  dplyr::select(condition, rep, context, noise = 'A2CEditingIndex',  signal = 'A2GEditingIndex')
 

ggplot(rna.editing.summary,
       aes(reorder(context, signal), signal, color = condition)) + 
  geom_point() +
  geom_point(reorder(context, signal), noise, color = condition, shape = 'diamond', alpha = 0.4) + 
  xlab('') + ylab('A-to-I Editing') + 
  scale_x_discrete(expand = c(0,0.5)) + 
  theme(axis.text.x = element_text(hjust = 1, angle = 40))

ggplot(rna.editing.summary,
       aes(condition, signal, color = context)) + 
  geom_boxplot(position = position_dodge(width = 1)) +  
  stat_compare_means(method = "t.test", label.y = 1.7) +
  geom_sina(position = position_dodge(width = 1)) +
  xlab('ALU TOTAL') + ylab('A-to-I Editing') + 
  scale_x_discrete(expand = c(0,0.5)) + 
  scale_y_continuous(limits = c(0,2), breaks = c(0,0.25,0.3,0.35,0.4,0.45,0.5,1,1.5,2))
```

## Fig. 2
### rerwip PCA
```{r}
set.seed(234)
### Gencode PCA
gene.patient.normalized.counts.pca <-
  salmon.quant$intra$deseq$gxi.vst.counts %>%
  rownames_to_column('ensg') %>% 
  merge(gencode.35.tx.to.gene %>% dplyr::select('ensg', 'gene') %>% distinct(), by = 'ensg') %>%
  distinct() %>% 
  filter(gene %in% msig.df$HALLMARK_KRAS_G12D_ZNF_DN) %>% 
  unite(col = 'gene', sep = '_', c('ensg', 'gene')) %>%
  gather(sample, count, -gene) %>% 
  filter(sample %in% rownames(anno_data)) %>% 
  spread(sample, count) %>% 
  mutate(gene.cv = rowSds(as.matrix(dplyr::select(., contains('.'))))/rowMeans(dplyr::select(., contains('.')))) %>% 
  filter(gene.cv >= median(gene.cv)) %>%
  dplyr::select(-gene.cv) %>%
  column_to_rownames('gene') %>%
  # dplyr::select(-ensg) %>% 
  t() %>% 
  as.data.frame() %>% 
  prcomp(scale=T, center = T)


sd_check <- apply(salmon.quant$aale$platform_compare$gxi.vst.counts, 1, sd)

pca_in <- salmon.quant$aale$platform_compare$gxi.vst.counts[sd_check != 0, ]

pca_in %>% 
  t() %>% 
  as.data.frame() %>% 
  prcomp(scale = T, center = T) -> gene.patient.normalized.counts.pca


summary(gene.patient.normalized.counts.pca)
pcs.of.interest <- apply(gene.patient.normalized.counts.pca$x, 2, var)
pcs.props <-  pcs.of.interest/sum(pcs.of.interest)
cumsum(pcs.props)[c(1,2)]

as.data.frame(pcs.props) %>% 
  rownames_to_column('pc') %>% 
  mutate(pc = as.numeric(sub('PC', '', pc))) %>% 
  ggplot(aes(pc, pcs.props)) + 
  geom_col()
 
# convert output to dataframe
pca.out <- as.data.frame(gene.patient.normalized.counts.pca$x) %>% 
  rownames_to_column('patient')

# summarize PC contributions
pca.out.summary <- 
  as.data.frame(summary(gene.patient.normalized.counts.pca)$importance) %>% 
  rownames_to_column('metric') %>% 
  gather(pc, value, -metric) %>% 
  spread(metric, value)
# summarize PC contributions
pca.out.contributions <- 
  as.data.frame(gene.patient.normalized.counts.pca$rotation) %>% 
  rownames_to_column('tx') %>% 
  gather(pc, contrib, -tx) %>% 
  group_by(pc) %>% 
  #merge(gencode.reference,
  #      by.x = 'tx',
  #      by.y = 'gene.name') %>% 
  group_by(pc) %>% 
  mutate(contrib = abs(contrib),
         rel.contrib = contrib/sum(contrib))

# plot PC1 and PC2
pca.out %>% 
  separate(patient, sep = '[.]',
           into = c('platform', 'context', 'rep', 'condition')) %>%
  # mutate(condition = factor(condition, levels = c('kras', 'ctrl', 'wt2_kras_v12', 'wt2_kras_wt', 'wt2_lacz'))) %>% 
  ggplot(aes(PC2, PC3,
             color = condition, shape = platform)) +
    geom_point(size = rel(4), alpha = 0.8) + 
    # scale_size_continuous(range = c(0.1, 2.5), breaks = c(0,5,10,15,20)) + 
    xlab(paste('PC1', round(cumsum(pcs.props)[1], digits = 3), sep = ' ')) +
    ylab(paste('PC2', round(cumsum(pcs.props)[2] - cumsum(pcs.props)[1], digits = 3), sep = ' ')) +
    scale_color_viridis_d() +
    geom_vline(xintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25) +
    geom_hline(yintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25)

panel.save(figure = 'hbec', name = 'znf_dn_pca', width = 'single', height = 'single', kras_up_pca.fig)



# pca.out %>% 
#   # rownames_to_column('sample') %>%
#   # merge(current.meta.data, by = 'patient') %>% 
#   # mutate(batch = as.factor(batch)) #%>% 
#   # merge(merge(unsplice.df, splice.df, by = 'sample') %>% 
#   #         mutate(unsplice_rate = unsplice_count / (unsplice_count + splice_count)),
#   merge(unsplice.df,
#         by.x = 'patient', by.y = 'sample') %>% 
#   #separate(sample, sep = '[.]', into = c(NA, 'condition', NA)) %>% 
#   ggplot(aes(PC1, PC2,
#              color = unsplice_rate)) + 
#     geom_point(size = rel(2)) + 
#     scale_size_continuous(range = c(0.1, 2.5), breaks = c(0,5,10,15,20)) + 
#     xlab(paste('PC1', round(cumsum(pcs.props)[1], digits = 3), sep = ' ')) +
#     ylab(paste('PC2', round(cumsum(pcs.props)[2] - cumsum(pcs.props)[1], digits = 3), sep = ' ')) +
#     # scale_color_viridis_c(name = 'batch', alpha = 0.6) + 
#     scale_color_gsea() +
#     geom_vline(xintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25) +
#     geom_hline(yintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25) + 
#     theme(legend.position = 'right',
#             legend.key.width = unit(0.125,'cm'),
#             legend.key.height = unit(0.4, 'cm')) 



# print top contibutors per PC
pca.out.contributions %>%
  group_by(pc) %>%
  filter(pc %in% c("PC1","PC2")) %>% 
  dplyr::select(pc, rel.contrib, tx) %>% 
  # mutate(contrib = abs(contrib)) %>% 
  top_n(5, wt = rel.contrib) %>% 
  arrange(pc, -rel.contrib)
```


```{r}
library(uwot)

set.seed(234)

pca_umap <- as.data.frame(umap(pca.out, n_neighbors = 4, learning_rate = 0.5, init = "random"))

rownames(pca_umap) <- pca.out$patient

pca_umap %>% 
  rownames_to_column('sample') %>% 
  merge(luad.phenotypes.merge, by = 'sample') -> uwot.gencode.plot
  # mutate(condition = sample) %>% 
  # separate(condition, sep = '[.]', into = c('platform', 'context', NA, 'condition')) -> uwot.gencode.plot

norm.counts.final %>% 
  filter(gene %in% de.agreement.list$up.consensus) %>% 
  mutate(gene.set = 'up.consensus') %>% 
  group_by(sample) %>% 
  summarize(count = mean(count)) %>% 
  mutate(count = scale(log(count + 1))) -> up.consensus.avg.count

ggplot(uwot.gencode.plot %>% merge(up.consensus.avg.count, by = 'sample'),
       aes(V1,V2, color = count, shape = KRAS)) +
  geom_point() +
  ylab('U2') + 
  xlab('U1') +
  geom_hline(yintercept = 0, linetype = 'dotted', alpha = 0.5, size = 0.25) + 
  geom_vline(xintercept = 0, linetype = 'dotted', alpha = 0.5, size = 0.25) + 
  # scale_color_manual(name = 'condition', values = viridis(3)[c(1,2,3)]) +
  scale_color_viridis_c() +
  theme(legend.position = 'right',
        legend.spacing = unit(0, 'in')) + theme(legend.position = c(0.95, 0.25))

ggplot(uwot.gencode.plot, 
       aes(V1, 
           V2, 
           color = unsplice_rate,
           label = patient)) +
  geom_point() +
  ylab('U2') + 
  xlab('U1') +
  geom_hline(yintercept = 0, linetype = 'dotted', alpha = 0.5, size = 0.25) + 
  geom_vline(xintercept = 0, linetype = 'dotted', alpha = 0.5, size = 0.25) + 
  # ggrepel::geom_text_repel(segment.color = NA,
  #                          point.padding = NA)  +
  # scale_color_manual(name = 'condition',
  #                    values = c('#37b578ff', '#440154ff')) +
  # scale_color_viridis_d() +
  scale_color_gsea() +
  theme(legend.position = 'right',
        legend.spacing = unit(0, 'in'))

```

#### rerwip Gencode Kmeans
```{r}
set.seed(234)

pca.for.clustering <- 
  pca.out %>% 
  dplyr::select(patient, PC1:PC5) %>%
  column_to_rownames('patient')

# pca.for.clustering <- 
#   pca_umap


elbow.plt(pca.for.clustering)

kmeans(pca.for.clustering, 5, nstart = 50) -> pca.k.means

pca.for.clustering %>% 
  rownames_to_column('patient') %>% 
  merge(current.meta.data, by.x = 'patient', by.y = 'patient') %>% 
  mutate(cluster = factor(pca.k.means$cluster)) ->
  pca.for.clustering

pca.for.clustering %>% 
  ggplot(aes(PC1, 
             PC2, 
             color = cluster, 
             # shape = condition,
             label = patient)) +
             # label = paste(paste(patient, sep = '.'),
             #               paste0(diabetes, '-', gender, '-', age,'yrs'),
             #               sep = ', '))) + 
  geom_point(size = rel(2)) + 
  geom_vline(xintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25) +
  geom_hline(yintercept = 0, linetype = 'dotted', alpha = 0.3, size = 0.25) + 
  xlab(paste('PC1', round(cumsum(pcs.props)[1], digits = 3), sep = ' ')) +
  ylab(paste('PC2', round(cumsum(pcs.props)[2] - cumsum(pcs.props)[1], 
                          digits = 3), sep = ' ')) +
  scale_color_viridis_d() #+ 
  # ggrepel::geom_text_repel(size = rel(3),
  #                          point.padding = 0.1,
  #                         box.padding = 0.2,
  #                         segment.color = NA,
  #                         color = 'black')

# panel.save(2, 'gender.filter.pca.kmeans.4')
```
### rerwip  NMF
```{r}
library(NMF)
set.seed(123)
salmon.tx.norm.for.nmf <- 
  ucsc.rmsk.salmon.quant$panc_v_ctrl$deseq$counts %>%
  rownames_to_column('gene') %>% 
  filter(gene %in% filter(ucsc.rmsk.salmon.quant$panc_v_ctrl$deseq$de, log2FoldChange <= -1)$gene) %>% 
  #filter_at(vars(contains('.')), all_vars(. >= 10)) %>% 
  # filter(gene %in% gen.34.lnc.names$gene, 
  #        gene %in% filter(patient.plasma.quant$de.seq$gencode.34.salmon.out, log2FoldChange > 1)$gene) %>%
  filter(!grepl('^RP|^HB|^MT|TMSB4X', gene)) %>%
  # filter(gene %in% filter(yang.ts.score.gtex, ! tissue %in% c('Cells', 'Whole Blood', 'Testis', 'Ovary', 'Uterus'))$gene) %>% 
  filter_at(vars(contains('.')), any_vars(. >= 1)) %>% 
  column_to_rownames('gene') %>% 
  t() %>% 
  as.data.frame()

# salmon.tx.norm.for.nmf <- 
#   patient.plasma.quant$gene$gencode.34.salmon.out %>% 
#   #filter_at(vars(contains('.')), all_vars(. >= 10)) %>% 
#   # filter(gene %in% gen.34.lnc.names$gene) %>% 
#   filter(!grepl('^HB|^MT|^S100|TMSB4X', gene)) %>% 
#   filter(gene %in% filter(yang.ts.score.gtex, ! tissue %in% c('Cells', 'Whole Blood', 'Testis', 'Ovary'))$gene) %>% 
#   filter_at(vars(contains('.')), any_vars(. >= 10)) %>% 
#   gather(sample, count, -gene) %>% 
#   merge(yang.ts.score.gtex, by = 'gene') %>% 
#   group_by(sample, tissue) %>% 
#   summarise(mean.counts = mean(count)) %>% 
#   spread(tissue, mean.counts) %>% 
#   column_to_rownames('sample') 

caret::nearZeroVar(salmon.tx.norm.for.nmf)

for(n in seq(2,5)){
  nmf.out <- nmf(salmon.tx.norm.for.nmf, n, nrun = 10)
  fit(nmf.out)
  print(paste(n, cophcor(nmf.out), sep = ':'))
}

nmf.out <- nmf(salmon.tx.norm.for.nmf, 5, nrun = 10)

as.data.frame(as.table(featureScore(nmf.out)[extractFeatures(nmf.out, 30L, 'list')[[1]]])) #%>% 
  merge(collison.subtype.genes,
        by.x = 'Var1',
        by.y = 'Genes') %>% 
  mutate(group = 'one') %>% 
  gather(type, score, -Var1, -group, -Freq) %>% 
  mutate(weighted.score = Freq * score) %>% 
  group_by(group, type) %>% 
  summarise(tot.score = mean(weighted.score) * 100)  -> group.1.nmf

as.data.frame(as.table(featureScore(nmf.out)[extractFeatures(nmf.out, 10L)[[2]]])) #%>% 
  merge(collison.subtype.genes,
        by.x = 'Var1',
        by.y = 'Genes') %>% 
  mutate(group = 'two') %>% 
  gather(type, score, -Var1, -group, -Freq) %>% 
  mutate(weighted.score = Freq * score) %>% 
  group_by(group, type) %>% 
  summarise(tot.score = mean(weighted.score) * 100) -> group.2.nmf

  
NMF::extractFeatures(nmf.out, method = 'max', nodups = T)

print(coef(nmf.out))

as.data.frame(coef(nmf.out)) %>% 
  rownames_to_column('basis') %>% 
  gather(gene, freq, -basis) %>% 
  group_by(gene) %>% 
  top_n(1, freq) %>% 
  group_by(basis) %>% 
  top_n(5, freq) %>% 
  

as.data.frame(coef(nmf.out)) %>% 
  rownames_to_column('basis') %>% 
  gather(gene, freq, -basis) %>% 
  merge(yang.ts.score.gtex, by = 'gene') %>% 
  group_by(basis, tissue) %>% 
  summarise(mean.freq = sum(freq)) %>% 
  group_by(basis) %>% 
  mutate(frac = mean.freq/sum(mean.freq)) %>% 
  dplyr::select(-mean.freq) %>%
  ggplot(aes(reorder(tissue, -frac), frac, fill = basis)) + 
  geom_col(position = 'dodge') + theme(axis.text.x = element_text(angle = 40, hjust = 1))
  # spread(tissue, frac) %>% 
  # column_to_rownames('basis') %>% 
  # t() %>% as.data.frame() %>% rownames_to_column('tissue') 
  # mutate(diff = `1` - `2`) %>% 
  # ggplot(aes(reorder(tissue, -diff), diff)) + 
  # geom_col() + theme(axis.text.x = element_text(angle = 40, hjust = 1))

as.data.frame(coef(nmf.out)) %>% 
  rownames_to_column('basis') %>% 
  gather(gene, freq, -basis) %>% 
  merge(yang.ts.score.gtex, by = 'gene') %>% 
  filter(tissue == 'Spleen') %>% 
  arrange(-freq) %>% 
  dplyr::select(gene, basis, freq) %>% 
  spread(basis, freq) %>% 
  mutate(diff = `1` - `2`) %>% 
  arrange(-diff)

as.data.frame(coef(nmf.out)) %>% 
  rownames_to_column('basis') %>% 
  gather(tissue, freq, -basis) %>% 
  # merge(yang.ts.score.gtex, by = 'gene') %>% 
  # filter(tissue == 'Spleen') %>% 
  arrange(-freq) %>% 
  # dplyr::select(gene, basis, freq) %>% 
  ggplot(aes(reorder(tissue, -freq),freq, fill = basis)) + 
  geom_col(position = 'dodge') +
  theme(axis.text.x = element_text(angle = 40, hjust = 1))
  


qqnorm(featureScore(nmf.out))
qqline(featureScore(nmf.out))
basismap(nmf.out)
coefmap(nmf.out)
```
### F: TE Family dist
```{r}
te.only.anno.counts %>% 
  gather(sample, count, -gene, -family, -clade) %>% 
  separate(sample, sep = '[.]', into = c(NA, 'condition', NA)) %>% 
  group_by(condition, family) %>% 
  summarise(count = sum(count)) %>% 
  group_by(condition) %>% 
  mutate(freq = count / sum(count)) %>% 
  top_n(4, freq) -> te.family.dist.plt

ggplot(te.family.dist.plt,
       aes(family, freq, fill = condition, color = condition)) + 
  geom_bar(position = position_dodge(width = .95), stat = 'identity') +
  scale_fill_viridis_d(alpha = 0.6) +
  scale_color_viridis_d() + 
  scale_x_discrete(expand = c(0, 0.5)) +
  geom_hline(yintercept = seq(0,1,0.25), color = 'white') + 
  xlab('') + ylab('% of total te-aligned reads')

# panel.save(1, 'f.te.family.compare')
  
```  

### G: Tx length dist
```{r}
tx.normalized.counts %>% 
  gather(sample, count, -tx:-biotype) %>% 
  separate(sample, sep = '[.]', into = c(NA, 'condition', NA)) %>% 
  mutate(len = as.numeric(len)) %>% 
  group_by(tx, condition) %>% 
  summarize(count = sum(count), len = median(len)) %>% 
  filter(count > 0, 
         len <= 10000) %>% 
  ungroup() %>% 
  group_by(condition) %>% 
  mutate(freq = count / sum(count)) -> tx.len.dist.plt

ggplot(tx.len.dist.plt, 
        aes(len, log(count + 1), fill = condition, color = condition)) + 
  geom_col(size = rel(0.8)) +
  scale_x_continuous(expand = c(0, 0.5), n.breaks = 15) +
  scale_fill_viridis_d(alpha = 0.6) +
  scale_color_viridis_d() + 
  geom_hline(yintercept = seq(0,200,40), color = 'white') + 
  xlab('transcript length') + ylab('log(normalized counts + 1)')

panel.save(1, 'g.tx.len.dist', width = 'double')
```

### H: Mapping rates 
```{r}
patient.read.mapping %>% 
  filter(patient %in% colnames(patient.plasma.quant$gene$gencode.34.salmon.out)) %>% 
  gather(approach, rate, -patient) %>% 
  ggplot(aes(patient, rate, fill = approach)) + 
  geom_bar(stat = 'identity', position = 'dodge') +
  scale_fill_viridis_d(direction = -1) +
  scale_color_viridis_d(direction = -1) + 
  geom_hline(yintercept = seq(0,1,0.25), color = 'white') +
  scale_x_discrete(expand = c(0, 0.5)) +
  xlab('') + ylab('# of detected genes') + 
  theme(axis.text.x = element_text(angle = 40, hjust = 1))
panel.save('supplement', 'patient.mapping.rate.compare', width = 'double')

patient.star.unique.mapping %>% 
  # filter(patient %in% colnames(patient.plasma.quant$gene$gencode.34.salmon.out)) %>% 
  mutate(context = ifelse(grepl('intra', patient), 'intra', 
                          ifelse(grepl('exo', patient), 'exo',
                                 'plasma'))) %>% 
  ggplot(aes(reorder(patient, -unique.reads/1e6), unique.reads/1e6,fill = mapping_rate)) + 
  geom_bar(stat = 'identity', position = 'dodge') +
  scale_fill_viridis_c(direction = -1) +
  scale_color_viridis_c(direction = -1) + 
  #geom_hline(yintercept = seq(0,6,1), color = 'white') +
  scale_x_discrete(expand = c(0, 0.5)) +
  xlab('') + ylab('millions of reads (uniquely mapped)') + 
  theme(axis.text.x = element_text(angle = 40, hjust = 1)) + 
  facet_col(~context, scales = 'free')
panel.save('supplement', 'all.data.star.rate.and.amount', width = 'double', height = 'double')


patient.star.detailed.mapping %>% 
  mutate(condition = ifelse(grepl('panc', patient), 'panc', 'ctrl')) %>% 
  filter(patient %in% colnames(patient.plasma.quant$gene$gencode.34.salmon.out)) %>%
  ggplot(aes(reorder(condition, -multi_map_rate), multi_map_rate)) + 
  # geom_bar(stat = 'identity') +
  geom_sina() + 
  geom_boxplot(fill = NA) +
  scale_fill_viridis_c(direction = -1) +
  scale_color_viridis_c(direction = -1) + 
  #geom_hline(yintercept = seq(0,6,1), color = 'white') +
  scale_x_discrete(expand = c(0, 0.5)) +
  xlab('') + ylab('STAR multimapping rate')
panel.save('supplement', 'patient.multi.mapping.rate.dist', width = 'single', height = 'single')

```




